<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Control Lucerito</title>
  <style>
    :root{
      --bg:#070b14;
      --card:#0e1528;
      --text:#eaf0ff;
      --muted:#94a3c7;
      --line:rgba(255,255,255,.08);

      --pri:#5aa9ff;
      --pri2:#8a5cff;
      --ok:#22c57a;
      --bad:#ff4b6b;
      --warn:#ffcc66;

      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r: 18px;
      --tap: 44px;
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(138,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(90,169,255,.20), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      min-height: 100%;
      padding-bottom: calc(84px + env(safe-area-inset-bottom));
    }

    /* Top header */
    .top{
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
      background: rgba(7,11,20,.66);
      border-bottom: 1px solid var(--line);
    }
    .top .bar{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .logoBox{
      width: 44px; height: 44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--pri), var(--pri2));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.12);
      position: relative;
    }
    .logoBox::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.20), transparent);
      transform: rotate(20deg) translateX(-90%);
      animation: shimmer 3.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{transform: rotate(20deg) translateX(-95%)}
      55%{transform: rotate(20deg) translateX(95%)}
      100%{transform: rotate(20deg) translateX(95%)}
    }
    .logoBox img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      position: relative;
      z-index: 1;
    }

    .brandTxt{min-width:0}
    /* ‚úÖ Animaci√≥n pro para el nombre */
    .brandTxt .t{
      font-weight: 1000;
      letter-spacing: .2px;
      font-size: 15px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      background: linear-gradient(90deg, #cfe7ff, #8bd3ff, #c6b5ff, #cfe7ff);
      background-size: 240% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: titleGlow 4.2s ease-in-out infinite;
      text-shadow: 0 10px 25px rgba(90,169,255,.10);
      transform: translateZ(0);
    }
    @keyframes titleGlow{
      0%{background-position: 0% 50%}
      50%{background-position: 100% 50%}
      100%{background-position: 0% 50%}
    }

    .brandTxt .s{
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chip{
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      display:flex; align-items:center; gap:8px;
      white-space: nowrap;
    }

    /* Segmented service switch */
    .segWrap{
      padding: 10px 14px 12px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .seg{
      flex:1;
      display:flex;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .seg button{
      flex:1;
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      min-height: var(--tap);
      transition: background .25s ease, color .25s ease, transform .05s ease;
    }
    .seg button:active{transform: translateY(1px)}
    .seg button.on{
      color: var(--text);
      background: linear-gradient(135deg, rgba(90,169,255,.28), rgba(138,92,255,.26));
    }

    /* Cards */
    .content{padding: 12px 14px 0}
    .card{
      background: rgba(14,21,40,.88);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card + .card{margin-top: 12px}
    .hd{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .hd .h{font-weight: 1000; font-size: 14px}
    .hd .sub{font-size: 12px; color: var(--muted); margin-top: 2px}
    .bd{padding: 14px}
    .muted{color: var(--muted)}

    /* Buttons */
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px}
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 1000;
      font-size: 13px;
      cursor:pointer;
      min-height: var(--tap);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      transition: transform .05s ease, background .2s ease, filter .2s ease, border-color .2s ease;
      user-select:none;
      flex: 1;
      text-decoration:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(90,169,255,.92), rgba(138,92,255,.92));
      border-color: rgba(255,255,255,.18);
    }
    .btn.ok{background: rgba(34,197,122,.12); border-color: rgba(34,197,122,.35)}
    .btn.danger{background: rgba(255,75,107,.12); border-color: rgba(255,75,107,.35)}
    .btn.ghost{background: rgba(255,255,255,.03)}
    .btn.small{
      padding: 10px 10px;
      border-radius: 12px;
      font-size: 12px;
      min-height: 40px;
      flex: unset;
    }

    /* Search + Pills */
    .search{display:flex; gap:10px; align-items:center}
    .search input{flex:1}
    .pill{
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    label{display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px}
    input, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, background .2s ease;
    }
    input:focus, textarea:focus{border-color: rgba(90,169,255,.45); background: rgba(0,0,0,.28)}
    textarea{resize:none}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap: 10px}
    @media (max-width:380px){ .two{grid-template-columns: 1fr} }

    /* List cards */
    .list{display:flex; flex-direction:column; gap: 10px}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      animation: slideIn .22s ease both;
    }
    @keyframes slideIn{
      from{opacity:0; transform: translateY(10px)}
      to{opacity:1; transform: translateY(0)}
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .name{font-weight: 1000; font-size: 14px; line-height:1.2}
    .meta{margin-top: 6px; font-size: 12px; color: var(--muted); line-height: 1.35}
    .badges{display:flex; flex-direction:column; gap:6px; align-items:flex-end}
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      font-weight: 900;
    }
    .b-ok{border-color: rgba(34,197,122,.35); background: rgba(34,197,122,.10)}
    .b-warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10)}
    .b-bad{border-color: rgba(255,75,107,.35); background: rgba(255,75,107,.10)}
    .itemBtns{display:flex; gap:8px; margin-top: 10px; flex-wrap:wrap}

    /* Bottom tab bar */
    .tabs{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(520px, 100%);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 30;
      backdrop-filter: blur(12px);
      background: rgba(7,11,20,.72);
      border-top: 1px solid var(--line);
    }
    .tabbar{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .tab{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      border-radius: 16px;
      min-height: 52px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      font-weight: 950;
      font-size: 11px;
      transition: background .2s ease, color .2s ease, transform .05s ease, border-color .2s ease;
    }
    .tab:active{transform: translateY(1px)}
    .tab.on{
      color: var(--text);
      border-color: rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(90,169,255,.22), rgba(138,92,255,.18));
    }
    .tab .ico{font-size: 16px}

    /* Views */
    .view{display:none}
    .view.on{display:block}
    .fadeIn{animation: fade .18s ease both}
    @keyframes fade{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

    /* Modal Receipt */
    .back{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 40;
      background: rgba(0,0,0,.62);
    }
    .modal{
      width: min(520px, 100%);
      background: rgba(14,21,40,.98);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: modalIn .2s ease both;
    }
    @keyframes modalIn{
      from{opacity:0; transform: translateY(12px) scale(.99)}
      to{opacity:1; transform: translateY(0) scale(1)}
    }
    .modal .mhd{
      padding: 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .modal .mbd{padding: 14px}

    /* ‚úÖ Receipt Pro */
    .receipt{
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }

    .rHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }

    .rBrand{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }

    .rLogo{
      width: 56px; height: 56px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      flex: 0 0 auto;
      display:grid; place-items:center;
    }
    .rLogo img{width:100%; height:100%; object-fit:cover; display:block}

    .rNames{min-width:0}
    .rBiz{
      font-weight: 1000;
      font-size: 15px;
      line-height: 1.15;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .rOwner{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .rMeta{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      flex: 0 0 auto;
    }
    .rTag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      white-space: nowrap;
      font-weight: 950;
    }

    .hr{height:1px; background: rgba(255,255,255,.10); margin: 12px 0}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:380px){ .grid2{grid-template-columns: 1fr} }

    .kv{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kv .k{font-size:12px; color: var(--muted)}
    .kv .v{font-size:13px; font-weight: 950; margin-top: 4px}

    .totalBox{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(90,169,255,.16), rgba(138,92,255,.12));
      padding: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }
    .totalBox .t{color: var(--muted); font-size: 12px; font-weight: 850}
    .totalBox .amt{font-size: 18px; font-weight: 1100}

    .pay{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      padding: 12px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .qr{
      width: 96px; height: 96px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      flex: 0 0 auto;
      display:grid;
      place-items:center;
    }
    .qr img{width:100%; height:100%; object-fit:cover; display:block}
    .pay .txt{font-size: 12px; color: var(--muted); line-height:1.35}
    .pay .txt b{color: var(--text)}
    .foot{
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
      line-height:1.45;
    }
    .sign{
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-end;
    }
    .sign .lineSign{
      flex:1;
      border-top: 1px dashed rgba(255,255,255,.18);
      padding-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* Print */
    @media print{
      .tabs, .top, .noPrint{display:none !important}
      body{background: white; color: black}
      .back{position: static; display:block; background: transparent; padding: 0}
      .modal{border: none; box-shadow:none}
      .receipt{
        border: 1px solid #aaa;
        background: white;
        color: black;
      }
      .receipt .rOwner, .receipt .foot, .receipt .kv .k, .receipt .pay .txt, .receipt .totalBox .t{color:#333 !important}
      .receipt .kv, .receipt .pay{border-color:#ccc !important; background:#fff !important}
      .receipt .totalBox{border-color:#bbb !important; background:#f6f7fb !important}
    }
  </style>
</head>
<body>

<div class="app">
  <header class="top">
    <div class="bar">
      <div class="brand">
        <div class="logoBox">
          <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        </div>
        <div class="brandTxt">
          <div class="t" id="bizTitle">Control Lucerito</div>
          <div class="s" id="subtitle">Internet ‚Ä¢ TV ‚Ä¢ Clientes</div>
        </div>
      </div>
      <div class="chip">üìÖ <span id="todayLbl"></span></div>
    </div>

    <div class="segWrap noPrint">
      <div class="seg">
        <button id="btnSvcInternet" class="on" type="button">üåê Internet</button>
        <button id="btnSvcTv" type="button">üì∫ Cable/TV</button>
      </div>
      <span class="pill" id="svcPill">Servicio: Internet</span>
    </div>
  </header>

  <main class="content">
    <!-- Inicio -->
    <section id="viewHome" class="view on fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">üìä Resumen</div>
            <div class="sub">Activos, vencidos y por vencer</div>
          </div>
          <span class="pill" id="totalLbl">0 clientes</span>
        </div>
        <div class="bd">
          <div class="two">
            <div class="item" style="margin:0">
              <div class="name">üü¢ Activos</div>
              <div class="meta"><b id="kActivos">0</b></div>
            </div>
            <div class="item" style="margin:0">
              <div class="name">üî¥ Vencidos</div>
              <div class="meta"><b id="kVencidos">0</b></div>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div class="item" style="margin:0">
              <div class="name">üü° Por vencer (‚â§ 3 d√≠as)</div>
              <div class="meta"><b id="kPorVencer">0</b></div>
            </div>
            <div class="item" style="margin:0">
              <div class="name">üë• Total</div>
              <div class="meta"><b id="kTotal">0</b></div>
            </div>
          </div>

          <div class="btnRow noPrint" style="margin-top:14px">
            <button class="btn primary" id="goClients">üë• Ir a Clientes</button>
            <button class="btn ghost" id="goAdd">‚ûï Agregar Cliente</button>
          </div>

          <div class="foot">üí° Al agregar: <b>Inicio = hoy</b> y <b>30 d√≠as</b> autom√°tico.</div>
        </div>
      </div>
    </section>

    <!-- Clientes (solo lista) -->
    <section id="viewClients" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">üë• Clientes</div>
            <div class="sub">Solo lista (agregar en ‚Äú+‚Äù)</div>
          </div>
          <button class="btn primary small noPrint" id="btnNew">‚ûï</button>
        </div>

        <div class="bd noPrint">
          <div class="search">
            <input id="q" placeholder="Buscar por nombre, DNI o WhatsApp‚Ä¶" />
            <span class="pill" id="countLbl">0</span>
          </div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn small" id="fAll" type="button">Todos</button>
            <button class="btn small ok" id="fActive" type="button">Activos</button>
            <button class="btn small" id="fSoon" type="button">Por vencer</button>
            <button class="btn small danger" id="fExpired" type="button">Vencidos</button>
          </div>
          <div class="foot muted" id="filterLbl" style="margin-top:10px">Filtro: Todos</div>
        </div>

        <div class="bd" style="padding-top: 0">
          <div id="list" class="list"></div>
          <div class="foot muted noPrint">Tip: toca ‚Äúüßæ Recibo‚Äù para enviarlo por WhatsApp.</div>
        </div>
      </div>
    </section>

    <!-- Agregar / Editar -->
    <section id="viewAdd" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h" id="addTitle">‚ûï Agregar cliente</div>
            <div class="sub">Inicio = hoy ‚Ä¢ 30 d√≠as autom√°tico</div>
          </div>
          <button class="btn small noPrint" id="btnBackClients">‚Ü©Ô∏è</button>
        </div>
        <div class="bd">
          <form id="clientForm">
            <input type="hidden" id="clientId" />

            <label>Nombre</label>
            <input id="nombre" required placeholder="Ej: Jose Lucero" />

            <div class="two">
              <div>
                <label>DNI</label>
                <input id="dni" inputmode="numeric" placeholder="Ej: 995218023" />
              </div>
              <div>
                <label>WhatsApp (c√≥digo pa√≠s)</label>
                <input id="whatsapp" inputmode="tel" placeholder="Ej: 51995218023" />
              </div>
            </div>

            <label>Plan / Servicio</label>
            <input id="plan" placeholder="Ej: Internet 50 Mbps / Cable HD" />

            <div class="two">
              <div>
                <label>Precio</label>
                <input id="precio" inputmode="decimal" placeholder="Ej: 60" />
              </div>
              <div>
                <label>D√≠as pagados</label>
                <input id="diasPagados" type="number" min="1" step="1" />
              </div>
            </div>

            <div class="two">
              <div>
                <label>Inicio (auto)</label>
                <input id="inicio" type="date" required />
              </div>
              <div>
                <label>Vence</label>
                <input id="vencePreview" disabled />
              </div>
            </div>

            <label>Notas</label>
            <textarea id="notas" rows="2" placeholder="Direcci√≥n, referencia, etc."></textarea>

            <div class="btnRow noPrint">
              <button class="btn primary" type="submit">üíæ Guardar</button>
              <button class="btn ghost" type="button" id="btnClear">üßº Limpiar</button>
            </div>

            <div class="btnRow noPrint">
              <button class="btn ok" type="button" id="btnReceiptFromForm" style="display:none">üßæ Ver Recibo</button>
              <button class="btn danger" type="button" id="btnDelete" style="display:none">üóëÔ∏è Eliminar</button>
            </div>

            <div class="foot muted">‚úÖ Activo si hoy ‚â§ vence. üü° Por vencer si le quedan 3 d√≠as o menos.</div>
          </form>
        </div>
      </div>
    </section>

    <!-- Ajustes -->
    <section id="viewSettings" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">‚öôÔ∏è Ajustes</div>
            <div class="sub">Logo + QR como archivos: logo.png y qr-yape.png</div>
          </div>
        </div>
        <div class="bd noPrint">
          <div class="btnRow">
            <button class="btn ok" id="btnExport" type="button">‚¨áÔ∏è Exportar</button>
            <button class="btn" id="btnImport" type="button">‚¨ÜÔ∏è Importar</button>
          </div>
          <input type="file" id="importFile" accept="application/json" hidden />
          <div class="btnRow">
            <button class="btn danger" id="btnReset" type="button">üß® Borrar todo</button>
          </div>
          <div class="foot">
            üìå En el recibo saldr√°: <b>Jos√© Lucero</b> ‚Ä¢ <b>+51 995 218 023</b> ‚Ä¢ QR Yape.
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Tabs -->
<nav class="tabs noPrint" aria-label="Navegaci√≥n">
  <div class="tabbar">
    <button class="tab on" data-tab="home" type="button"><div class="ico">üè†</div><div>Inicio</div></button>
    <button class="tab" data-tab="clients" type="button"><div class="ico">üë•</div><div>Clientes</div></button>
    <button class="tab" data-tab="add" type="button"><div class="ico">‚ûï</div><div>Agregar</div></button>
    <button class="tab" data-tab="settings" type="button"><div class="ico">‚öôÔ∏è</div><div>Ajustes</div></button>
  </div>
</nav>

<!-- Modal Recibo -->
<div class="back" id="back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <div style="font-weight:1000">üßæ Recibo</div>
      <div style="display:flex; gap:8px; align-items:center" class="noPrint">
        <button class="btn small" id="btnPrint" type="button">üñ®Ô∏è</button>
        <a class="btn small ok" id="btnWA" target="_blank" rel="noopener">üü¢</a>
        <button class="btn small" id="btnClose" type="button">‚úñÔ∏è</button>
      </div>
    </div>
    <div class="mbd">
      <div class="receipt" id="receiptBox"></div>
    </div>
  </div>
</div>

<script>
  // üî®ü§ñüîß Control Lucerito - Recibo PRO + N¬∞ correlativo

  // ‚úÖ Tus datos (como pediste)
  const BUSINESS_NAME = "Control Lucerito";
  const OWNER_NAME = "Jos√© Lucero";
  const OWNER_PHONE = "+51 995 218 023";
  const YAPE_PHONE = OWNER_PHONE;

  // LocalStorage keys
  const KEYS = {
    data: "lucerito_data_v4",
    receiptCounter: "lucerito_receipt_counter_v1"
  };

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const el = {
    todayLbl: $("#todayLbl"),
    subtitle: $("#subtitle"),
    bizTitle: $("#bizTitle"),
    svcPill: $("#svcPill"),

    btnSvcInternet: $("#btnSvcInternet"),
    btnSvcTv: $("#btnSvcTv"),

    viewHome: $("#viewHome"),
    viewClients: $("#viewClients"),
    viewAdd: $("#viewAdd"),
    viewSettings: $("#viewSettings"),

    tabs: $$(".tab"),

    kActivos: $("#kActivos"),
    kVencidos: $("#kVencidos"),
    kPorVencer: $("#kPorVencer"),
    kTotal: $("#kTotal"),
    totalLbl: $("#totalLbl"),

    goClients: $("#goClients"),
    goAdd: $("#goAdd"),

    btnNew: $("#btnNew"),
    q: $("#q"),
    list: $("#list"),
    countLbl: $("#countLbl"),
    filterLbl: $("#filterLbl"),
    fAll: $("#fAll"),
    fActive: $("#fActive"),
    fSoon: $("#fSoon"),
    fExpired: $("#fExpired"),

    addTitle: $("#addTitle"),
    btnBackClients: $("#btnBackClients"),
    form: $("#clientForm"),
    clientId: $("#clientId"),
    nombre: $("#nombre"),
    dni: $("#dni"),
    whatsapp: $("#whatsapp"),
    plan: $("#plan"),
    precio: $("#precio"),
    diasPagados: $("#diasPagados"),
    inicio: $("#inicio"),
    vencePreview: $("#vencePreview"),
    notas: $("#notas"),
    btnClear: $("#btnClear"),
    btnDelete: $("#btnDelete"),
    btnReceiptFromForm: $("#btnReceiptFromForm"),

    btnExport: $("#btnExport"),
    btnImport: $("#btnImport"),
    importFile: $("#importFile"),
    btnReset: $("#btnReset"),

    back: $("#back"),
    receiptBox: $("#receiptBox"),
    btnClose: $("#btnClose"),
    btnPrint: $("#btnPrint"),
    btnWA: $("#btnWA"),
  };

  /** @typedef {'internet'|'tv'} Service */
  /** @typedef {'all'|'active'|'soon'|'expired'} Filter */
  /** @typedef {{
    no: number,
    vence: string,
    createdAt: number
  }} LastReceipt */
  /** @typedef {{
    id: string,
    service: Service,
    nombre: string,
    dni: string,
    whatsapp: string,
    plan: string,
    precio: number,
    inicio: string,
    diasPagados: number,
    notas: string,
    lastReceipt?: LastReceipt,
    createdAt: number,
    updatedAt: number
  }} Client */

  const state = {
    service: /** @type {Service} */ ("internet"),
    filter: /** @type {Filter} */ ("all"),
    clients: /** @type {Client[]} */ ([]),
    selectedId: null,
  };

  // Dates
  const pad2 = (n) => String(n).padStart(2, "0");
  const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const todayISO = () => toISODate(new Date());
  const parseISO = (iso) => {
    const [y,m,d] = iso.split("-").map(Number);
    return new Date(y, m-1, d, 12, 0, 0);
  };
  const addDays = (iso, days) => {
    const d = parseISO(iso);
    d.setDate(d.getDate() + Number(days || 0));
    return toISODate(d);
  };
  const diffDays = (fromISO, toISO) => {
    const a = parseISO(fromISO).getTime();
    const b = parseISO(toISO).getTime();
    return Math.round((b - a) / (1000*60*60*24));
  };
  const formatDate = (iso) => {
    const d = parseISO(iso);
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  };

  // Utils
  const uid = () => "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const normalizePhone = (p) => (p || "").replace(/[^\d]/g, "");
  const money = (n) => {
    const v = Number(n || 0);
    if (!isFinite(v)) return "0";
    return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  };

  function load(){
    try{
      const raw = localStorage.getItem(KEYS.data);
      state.clients = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(state.clients)) state.clients = [];
    }catch{ state.clients = []; }
  }
  function save(){
    localStorage.setItem(KEYS.data, JSON.stringify(state.clients));
  }

  function compute(client){
    const vence = addDays(client.inicio, client.diasPagados);
    const hoy = todayISO();
    const daysLeft = diffDays(hoy, vence);
    const isActive = daysLeft >= 0;
    const isSoon = isActive && daysLeft <= 3;
    const isExpired = !isActive;
    return { vence, hoy, daysLeft, isActive, isSoon, isExpired };
  }

  function statusBadge(st){
    if (st.isExpired) return `<span class="badge b-bad">üî¥ Vencido</span>`;
    if (st.isSoon) return `<span class="badge b-warn">üü° Por vencer</span>`;
    return `<span class="badge b-ok">üü¢ Activo</span>`;
  }
  function daysText(st){
    if (st.isExpired) return `Venci√≥ hace <b>${Math.abs(st.daysLeft)}</b> d√≠a(s)`;
    return `Le quedan <b>${st.daysLeft}</b> d√≠a(s)`;
  }

  function applyService(list){ return list.filter(c => c.service === state.service); }

  function applyFilter(list){
    const q = el.q.value.trim().toLowerCase();
    let out = list;

    if (q){
      out = out.filter(c => (c.nombre + " " + c.dni + " " + c.whatsapp).toLowerCase().includes(q));
    }
    out = out.filter(c => {
      const st = compute(c);
      if (state.filter === "active") return st.isActive;
      if (state.filter === "soon") return st.isSoon;
      if (state.filter === "expired") return st.isExpired;
      return true;
    });

    out.sort((a,b) => {
      const A = compute(a), B = compute(b);
      if (A.isExpired !== B.isExpired) return A.isExpired ? -1 : 1;
      if (A.isSoon !== B.isSoon) return A.isSoon ? -1 : 1;
      if (A.daysLeft !== B.daysLeft) return A.daysLeft - B.daysLeft;
      return (a.nombre || "").localeCompare(b.nombre || "");
    });
    return out;
  }

  // Views / tabs
  function setTab(tab){
    el.tabs.forEach(t => t.classList.toggle("on", t.dataset.tab === tab));
    el.viewHome.classList.toggle("on", tab === "home");
    el.viewClients.classList.toggle("on", tab === "clients");
    el.viewAdd.classList.toggle("on", tab === "add");
    el.viewSettings.classList.toggle("on", tab === "settings");

    const svcTxt = state.service === "internet" ? "Internet" : "Cable/TV";
    if (tab === "home") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Resumen`;
    if (tab === "clients") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Clientes`;
    if (tab === "add") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Agregar/Editar`;
    if (tab === "settings") el.subtitle.textContent = `Panel ‚Ä¢ Ajustes`;

    const view = tab === "home" ? el.viewHome : tab === "clients" ? el.viewClients : tab === "add" ? el.viewAdd : el.viewSettings;
    view.classList.remove("fadeIn");
    void view.offsetWidth;
    view.classList.add("fadeIn");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Service switch
  function setService(svc){
    state.service = svc;
    el.btnSvcInternet.classList.toggle("on", svc === "internet");
    el.btnSvcTv.classList.toggle("on", svc === "tv");
    el.svcPill.textContent = "Servicio: " + (svc === "internet" ? "Internet" : "Cable/TV");
    el.plan.placeholder = svc === "internet" ? "Ej: Internet 50 Mbps" : "Ej: Cable HD";
    el.q.value = "";
    setFilter("all", false);
    renderAll();
  }

  function updateVencePreview(){
    const inicio = el.inicio.value || todayISO();
    const dias = Number(el.diasPagados.value || 30);
    const vence = addDays(inicio, dias);
    el.vencePreview.value = formatDate(vence);
  }

  function newClientForm(){
    state.selectedId = null;
    el.clientId.value = "";
    el.addTitle.textContent = "‚ûï Agregar cliente";
    el.nombre.value = "";
    el.dni.value = "";
    el.whatsapp.value = "";
    el.plan.value = "";
    el.precio.value = "";
    el.notas.value = "";
    el.inicio.value = todayISO();
    el.diasPagados.value = 30;
    updateVencePreview();
    el.btnDelete.style.display = "none";
    el.btnReceiptFromForm.style.display = "none";
  }

  function fillForm(client){
    state.selectedId = client.id;
    el.clientId.value = client.id;
    el.addTitle.textContent = "‚úèÔ∏è Editar cliente";
    el.nombre.value = client.nombre || "";
    el.dni.value = client.dni || "";
    el.whatsapp.value = client.whatsapp || "";
    el.plan.value = client.plan || "";
    el.precio.value = (client.precio ?? "") === 0 ? "0" : String(client.precio ?? "");
    el.notas.value = client.notas || "";
    el.inicio.value = client.inicio || todayISO();
    el.diasPagados.value = String(client.diasPagados ?? 30);
    updateVencePreview();
    el.btnDelete.style.display = "inline-flex";
    el.btnReceiptFromForm.style.display = "inline-flex";
  }

  function upsertFromForm(){
    const id = el.clientId.value || uid();
    const now = Date.now();

    const nombre = el.nombre.value.trim();
    const dni = el.dni.value.trim();
    const whatsapp = normalizePhone(el.whatsapp.value.trim());
    const plan = el.plan.value.trim();
    const precio = Number(String(el.precio.value).replace(",", "."));
    const inicio = el.inicio.value || todayISO();
    const diasPagados = Number(el.diasPagados.value || 30);
    const notas = el.notas.value.trim();

    if (!nombre) return alert("Falta el nombre.");
    if (!diasPagados || diasPagados < 1) return alert("D√≠as pagados debe ser m√≠nimo 1.");

    const existing = state.clients.find(c => c.id === id);
    /** @type {Client} */
    const client = existing ? { ...existing } : {
      id,
      service: state.service,
      nombre:"",
      dni:"",
      whatsapp:"",
      plan:"",
      precio:0,
      inicio: todayISO(),
      diasPagados: 30,
      notas:"",
      createdAt: now,
      updatedAt: now
    };

    client.service = state.service;
    client.nombre = nombre;
    client.dni = dni;
    client.whatsapp = whatsapp;
    client.plan = plan || (state.service === "internet" ? "Internet" : "Cable/TV");
    client.precio = isFinite(precio) ? precio : 0;
    client.inicio = inicio;
    client.diasPagados = diasPagados;
    client.notas = notas;
    client.updatedAt = now;

    if (!existing) state.clients.push(client);
    else state.clients = state.clients.map(c => c.id === id ? client : c);

    save();
    renderAll();
    fillForm(client);
    navigator.vibrate?.(25);
    alert("Guardado ‚úÖ");
  }

  function removeClient(id){
    const client = state.clients.find(c => c.id === id);
    if (!client) return;
    const ok = confirm(`¬øEliminar a "${client.nombre}"?`);
    if (!ok) return;
    state.clients = state.clients.filter(c => c.id !== id);
    save();
    renderAll();
    newClientForm();
    setTab("clients");
  }

  // ‚úÖ Receipt number (correlativo)
  function nextReceiptNo(){
    const cur = Number(localStorage.getItem(KEYS.receiptCounter) || "0");
    const next = cur + 1;
    localStorage.setItem(KEYS.receiptCounter, String(next));
    return next;
  }
  function formatReceiptNo(n){
    return String(n).padStart(4, "0"); // 0001, 0002...
  }

  // ‚úÖ Build receipt (PRO + datos Jos√© Lucero + N¬∞ Recibo)
  function buildReceipt(client){
    const st = compute(client);
    const fecha = todayISO();
    const svcName = client.service === "internet" ? "INTERNET" : "CABLE/TV";

    // Reusar el mismo n√∫mero si el vencimiento es el mismo (evita subir n√∫meros al abrir varias veces)
    let receiptNo;
    if (client.lastReceipt && client.lastReceipt.vence === st.vence){
      receiptNo = client.lastReceipt.no;
    } else {
      receiptNo = nextReceiptNo();
      client.lastReceipt = { no: receiptNo, vence: st.vence, createdAt: Date.now() };
      // persistimos para que quede guardado
      state.clients = state.clients.map(c => c.id === client.id ? client : c);
      save();
    }

    const receiptNoTxt = formatReceiptNo(receiptNo);

    const msg = [
      `Hola ${client.nombre} üëã`,
      `Te env√≠o tu recibo del servicio de ${svcName}.`,
      ``,
      `üßæ RECIBO N¬∞ ${receiptNoTxt} - ${svcName}`,
      `Cliente: ${client.nombre}`,
      client.dni ? `DNI: ${client.dni}` : null,
      `Plan: ${client.plan}`,
      `Inicio: ${formatDate(client.inicio)}`,
      `Vence: ${formatDate(st.vence)}`,
      `D√≠as pagados: ${client.diasPagados}`,
      `Monto: ${money(client.precio)}`,
      ``,
      st.isExpired ? `üî¥ Estado: VENCIDO` : (st.isSoon ? `üü° Estado: POR VENCER` : `üü¢ Estado: ACTIVO`),
      st.isExpired ? `Venci√≥ hace ${Math.abs(st.daysLeft)} d√≠a(s).` : `Le quedan ${st.daysLeft} d√≠a(s).`,
      ``,
      `Pago por Yape: ${YAPE_PHONE}`,
      `Atiende: ${OWNER_NAME} (${OWNER_PHONE})`,
      `‚Äî ${BUSINESS_NAME}`
    ].filter(Boolean).join("\n");

    const phone = normalizePhone(client.whatsapp);
    const waUrl = phone ? `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(msg)}` : null;

    const estadoTxt = st.isExpired ? "VENCIDO" : (st.isSoon ? "POR VENCER" : "ACTIVO");

const html = `
      <div class="rHeader">
        <div class="rBrand">
          <div class="rLogo">
            <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
          </div>
          <div class="rNames">
            <div class="rBiz">${escapeHtml(BUSINESS_NAME)}</div>
            <div class="rOwner">${escapeHtml(OWNER_NAME)} ‚Ä¢ ${escapeHtml(OWNER_PHONE)}</div>
          </div>
        </div>

        <div class="rMeta">
          <div class="rTag">Recibo N¬∞ ${receiptNoTxt}</div>
          <div class="rTag">${formatDate(fecha)}</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="kv">
          <div class="k">Cliente</div>
          <div class="v">${escapeHtml(client.nombre)}</div>
        </div>
        <div class="kv">
          <div class="k">Servicio</div>
          <div class="v">${svcName}</div>
        </div>

        <div class="kv">
          <div class="k">Plan</div>
          <div class="v">${escapeHtml(client.plan)}</div>
        </div>
        <div class="kv">
          <div class="k">Estado</div>
          <div class="v">${estadoTxt} ‚Ä¢ ${daysText(st)}</div>
        </div>

        <div class="kv">
          <div class="k">Inicio</div>
          <div class="v">${formatDate(client.inicio)}</div>
        </div>
        <div class="kv">
          <div class="k">Vence</div>
          <div class="v">${formatDate(st.vence)}</div>
        </div>

        <div class="kv">
          <div class="k">D√≠as pagados</div>
          <div class="v">${client.diasPagados}</div>
        </div>
        <div class="kv">
          <div class="k">Contacto</div>
          <div class="v">${client.whatsapp ? escapeHtml(client.whatsapp) : "‚Äî"}</div>
        </div>

        ${client.dni ? `
          <div class="kv" style="grid-column: 1 / -1;">
            <div class="k">DNI</div>
            <div class="v">${escapeHtml(client.dni)}</div>
          </div>` : ""
        }
      </div>

      <div class="totalBox">
        <div>
          <div class="t">Total a pagar</div>
          <div class="t">(${svcName})</div>
        </div>
        <div class="amt">${money(client.precio)}</div>
      </div>

      <div style="margin-top:10px">${statusBadge(st)}</div>

      <div class="pay">
        <div class="qr">
          <img src="qr-yape.png" alt="QR Yape" onerror="this.style.display='none'">
        </div>
        <div class="txt">
          <div style="font-weight:1000; color: var(--text)">Pago por Yape</div>
          Escanea el QR o transfiere al n√∫mero:<br>
          <b>${escapeHtml(YAPE_PHONE)}</b><br>
          <span class="muted">Luego env√≠a captura por WhatsApp para confirmar.</span>
        </div>
      </div>

      <div class="foot">
        ${client.notas ? `<b>Notas:</b> ${escapeHtml(client.notas)}<br>` : ""}
        <b>Atenci√≥n:</b> ${escapeHtml(OWNER_NAME)} ‚Ä¢ ${escapeHtml(OWNER_PHONE)}<br>
        Gracias por tu preferencia üôå
      </div>

      <div class="sign">
        <div class="lineSign">Firma / Sello</div>
        <div class="lineSign">Cliente</div>
      </div>
    `;

    return { html, waUrl };
  }

  function openReceipt(id){
    const client = state.clients.find(c => c.id === id);
    if (!client) return;

    const r = buildReceipt(client);
    el.receiptBox.innerHTML = r.html;

    if (r.waUrl){
      el.btnWA.href = r.waUrl;
      el.btnWA.textContent = "üü¢";
      el.btnWA.style.opacity = "1";
      el.btnWA.style.pointerEvents = "auto";
    }else{
      el.btnWA.href = "#";
      el.btnWA.textContent = "‚ö†Ô∏è";
      el.btnWA.style.opacity = ".6";
      el.btnWA.style.pointerEvents = "none";
    }

    el.back.style.display = "flex";
  }

  function closeReceipt(){ el.back.style.display = "none"; }

  // Export/Import/Reset
  function exportJSON(){
    const payload = {
      app: BUSINESS_NAME,
      version: 4,
      exportedAt: new Date().toISOString(),
      business: { BUSINESS_NAME, OWNER_NAME, OWNER_PHONE, YAPE_PHONE },
      clients: state.clients
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `control_lucerito_backup_${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importJSON(file){
    try{
      const text = await file.text();
      const payload = JSON.parse(text);
      const incoming = payload?.clients;
      if (!Array.isArray(incoming)) throw new Error("Archivo inv√°lido: no existe clients[]");

      const cleaned = incoming
        .filter(x => x && typeof x === "object")
        .map(x => ({
          id: String(x.id || uid()),
          service: (x.service === "tv" ? "tv" : "internet"),
          nombre: String(x.nombre || ""),
          dni: String(x.dni || ""),
          whatsapp: normalizePhone(String(x.whatsapp || "")),
          plan: String(x.plan || ""),
          precio: Number(x.precio || 0),
          inicio: String(x.inicio || todayISO()),
          diasPagados: Number(x.diasPagados || 30),
          notas: String(x.notas || ""),
          lastReceipt: (x.lastReceipt && typeof x.lastReceipt === "object")
            ? { no: Number(x.lastReceipt.no || 0), vence: String(x.lastReceipt.vence || ""), createdAt: Number(x.lastReceipt.createdAt || Date.now()) }
            : undefined,
          createdAt: Number(x.createdAt || Date.now()),
          updatedAt: Number(x.updatedAt || Date.now())
        }))
        .filter(x => x.nombre.trim().length > 0);

      const map = new Map(state.clients.map(c => [c.id, c]));
      for (const c of cleaned) map.set(c.id, c);
      state.clients = Array.from(map.values());

      save();
      renderAll();
      alert("Importado ‚úÖ");
    }catch(err){
      alert("No se pudo importar ‚ùå\n" + (err?.message || err));
    }
  }

  function resetAll(){
    const ok = confirm("¬øSeguro? Esto borrar√° TODO en este dispositivo.");
    if (!ok) return;
    state.clients = [];
    save();
    renderAll();
    newClientForm();
    setTab("home");
  }

  // Render
  function renderKPIs(){
    const list = applyService(state.clients);
    let activos=0, vencidos=0, porVencer=0;

    for (const c of list){
      const st = compute(c);
      if (st.isExpired) vencidos++;
      else activos++;
      if (st.isSoon) porVencer++;
    }
    el.kActivos.textContent = String(activos);
    el.kVencidos.textContent = String(vencidos);
    el.kPorVencer.textContent = String(porVencer);
    el.kTotal.textContent = String(list.length);
    el.totalLbl.textContent = `${list.length} clientes`;
  }

  function renderList(){
    const svcList = applyService(state.clients);
    const filtered = applyFilter(svcList);
    el.countLbl.textContent = String(filtered.length);

    const map = { all:"Todos", active:"Activos", soon:"Por vencer", expired:"Vencidos" };
    el.filterLbl.textContent = `Filtro: ${map[state.filter]}`;

    if (filtered.length === 0){
      el.list.innerHTML = `
        <div class="item">
          <div class="name">No hay clientes aqu√≠ üòÖ</div>
          <div class="meta">Toca ‚Äú‚ûï‚Äù para agregar uno.</div>
        </div>`;
      return;
    }

    el.list.innerHTML = filtered.map(c => {
      const st = compute(c);
      const venceTxt = formatDate(st.vence);
      const inicioTxt = formatDate(c.inicio);

      const contact = [
        c.dni ? `DNI: <b>${escapeHtml(c.dni)}</b>` : "",
        c.whatsapp ? `WA: <b>${escapeHtml(c.whatsapp)}</b>` : "<span class='muted'>Sin WhatsApp</span>"
      ].filter(Boolean).join("<br>");

      const svcName = c.service === "internet" ? "Internet" : "Cable/TV";
      const plan = `<b>${escapeHtml(c.plan || svcName)}</b><br><span class="muted">Precio:</span> <b>${money(c.precio)}</b>`;

      return `
        <div class="item">
          <div class="itemTop">
            <div>
              <div class="name">${escapeHtml(c.nombre)}</div>
              <div class="meta">
                ${contact}<br>
                <span class="muted">Servicio:</span> <b>${svcName}</b><br>
                ${plan}<br>
                <span class="muted">Inicio:</span> <b>${inicioTxt}</b> ‚Ä¢ <span class="muted">Vence:</span> <b>${venceTxt}</b><br>
                ${daysText(st)}
              </div>
            </div>
            <div class="badges">
              ${statusBadge(st)}
            </div>
          </div>

          <div class="itemBtns noPrint">
            <button class="btn small" data-act="edit" data-id="${c.id}" type="button">‚úèÔ∏è Editar</button>
            <button class="btn small ok" data-act="receipt" data-id="${c.id}" type="button">üßæ Recibo</button>
            <button class="btn small danger" data-act="del" data-id="${c.id}" type="button">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderAll(){
    el.bizTitle.textContent = BUSINESS_NAME;
    el.todayLbl.textContent = formatDate(todayISO());
    renderKPIs();
    renderList();
  }

  function setFilter(f, rerender=true){
    state.filter = f;
    if (rerender) renderList();
  }

  // Events
  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

  el.btnSvcInternet.addEventListener("click", () => setService("internet"));
  el.btnSvcTv.addEventListener("click", () => setService("tv"));

  el.goClients.addEventListener("click", () => setTab("clients"));
  el.goAdd.addEventListener("click", () => { newClientForm(); setTab("add"); });

  el.btnNew.addEventListener("click", () => { newClientForm(); setTab("add"); });
  el.btnBackClients.addEventListener("click", () => setTab("clients"));

  el.inicio.addEventListener("change", updateVencePreview);
  el.diasPagados.addEventListener("input", updateVencePreview);

  el.form.addEventListener("submit", (e) => { e.preventDefault(); upsertFromForm(); });
  el.btnClear.addEventListener("click", newClientForm);

  el.btnDelete.addEventListener("click", () => state.selectedId && removeClient(state.selectedId));
  el.btnReceiptFromForm.addEventListener("click", () => state.selectedId && openReceipt(state.selectedId));

  el.q.addEventListener("input", renderList);
  el.fAll.addEventListener("click", () => setFilter("all"));
  el.fActive.addEventListener("click", () => setFilter("active"));
  el.fSoon.addEventListener("click", () => setFilter("soon"));
  el.fExpired.addEventListener("click", () => setFilter("expired"));

  el.list.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    if (!id || !act) return;

    if (act === "edit"){
      const c = state.clients.find(x => x.id === id);
      if (c){ fillForm(c); setTab("add"); }
    }
    if (act === "receipt") openReceipt(id);
    if (act === "del") removeClient(id);
  });

  el.btnClose.addEventListener("click", closeReceipt);
  el.back.addEventListener("click", (e) => { if (e.target === el.back) closeReceipt(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeReceipt(); });
  el.btnPrint.addEventListener("click", () => window.print());

  el.btnExport.addEventListener("click", exportJSON);
  el.btnImport.addEventListener("click", () => el.importFile.click());
  el.btnReset.addEventListener("click", resetAll);

  el.importFile.addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if (f) importJSON(f);
    el.importFile.value = "";
  });

  // Init
  load();
  newClientForm();
  setService("internet");
  setFilter("all", false);
  renderAll();
  setTab("home");
</script>

</body>
</html>
‚úÖ