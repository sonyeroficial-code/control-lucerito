<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Control Lucerito</title>

  <style>
    :root{
      --bg:#070b14; --card:#0e1528; --text:#eaf0ff; --muted:#94a3c7; --line:rgba(255,255,255,.08);
      --pri:#5aa9ff; --pri2:#8a5cff; --ok:#22c57a; --bad:#ff4b6b; --warn:#ffcc66;
      --shadow: 0 16px 40px rgba(0,0,0,.45); --r: 18px; --tap: 44px;
      --topBg: rgba(7,11,20,.66); --tabsBg: rgba(7,11,20,.72); --modalBg: rgba(14,21,40,.98);
      --glass: rgba(255,255,255,.05); --glass2: rgba(255,255,255,.04);
      --inputBg: rgba(0,0,0,.22); --inputBgFocus: rgba(0,0,0,.28);
      --chipBg: rgba(255,255,255,.05); --btnBg: rgba(255,255,255,.06); --btnGhost: rgba(255,255,255,.03);
      --itemBg: rgba(255,255,255,.03);
      --receiptBg1: rgba(255,255,255,.05); --receiptBg2: rgba(255,255,255,.02);
    }
    body.light{
      --bg:#f5f7ff; --card:#ffffff; --text:#0b1220; --muted:#52607a; --line:rgba(15,23,42,.12);
      --shadow: 0 14px 34px rgba(15,23,42,.10);
      --topBg: rgba(245,247,255,.78); --tabsBg: rgba(245,247,255,.82); --modalBg: rgba(255,255,255,.98);
      --glass: rgba(15,23,42,.04); --glass2: rgba(15,23,42,.035);
      --inputBg: rgba(15,23,42,.04); --inputBgFocus: rgba(15,23,42,.06);
      --chipBg: rgba(15,23,42,.04); --btnBg: rgba(15,23,42,.05); --btnGhost: rgba(15,23,42,.03);
      --itemBg: rgba(15,23,42,.03);
      --receiptBg1: rgba(15,23,42,.03); --receiptBg2: rgba(15,23,42,.02);
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(138,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(90,169,255,.20), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }
    body.light{
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(138,92,255,.14), transparent 58%),
        radial-gradient(900px 600px at 85% 0%, rgba(90,169,255,.12), transparent 58%),
        var(--bg);
    }

    .app{max-width:520px; margin:0 auto; min-height:100%; padding-bottom: calc(84px + env(safe-area-inset-bottom));}
    @media (min-width: 900px){ .app{max-width:980px; padding-bottom:0} .content{padding-bottom:110px} }

    .top{
      position: sticky; top:0; z-index:20;
      backdrop-filter: blur(12px);
      background: var(--topBg);
      border-bottom: 1px solid var(--line);
    }
    .top .bar{padding:14px 14px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logoBox{
      width:44px; height:44px; border-radius:16px;
      background: linear-gradient(135deg, var(--pri), var(--pri2));
      box-shadow: var(--shadow); overflow:hidden; display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12); position:relative;
    }
    body.light .logoBox{border-color: rgba(15,23,42,.12)}
    .logoBox::after{
      content:""; position:absolute; inset:-30%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.20), transparent);
      transform: rotate(20deg) translateX(-90%);
      animation: shimmer 3.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{ 0%{transform: rotate(20deg) translateX(-95%)} 55%{transform: rotate(20deg) translateX(95%)} 100%{transform: rotate(20deg) translateX(95%)} }
    .logoBox img{width:100%; height:100%; object-fit:cover; display:block; position:relative; z-index:1;}

    .brandTxt{min-width:0}
    .brandTxt .t{
      font-weight:1000; letter-spacing:.2px; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      background: linear-gradient(90deg, #cfe7ff, #8bd3ff, #c6b5ff, #cfe7ff);
      background-size: 240% 100%;
      -webkit-background-clip:text; background-clip:text; color: transparent;
      animation: titleGlow 4.2s ease-in-out infinite;
      text-shadow: 0 10px 25px rgba(90,169,255,.10);
    }
    @keyframes titleGlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .brandTxt .s{font-size:12px; color: var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chip{
      padding:8px 10px; border:1px solid var(--line); background: var(--chipBg);
      border-radius:999px; color: var(--muted); font-size:12px; display:flex; align-items:center; gap:8px; white-space:nowrap;
    }

    .segWrap{padding:10px 14px 12px; display:flex; gap:10px; justify-content:space-between; align-items:center;}
    .seg{
      flex:1; display:flex; background: var(--glass); border:1px solid var(--line); border-radius:16px; overflow:hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    body.light .seg{box-shadow: 0 10px 25px rgba(15,23,42,.08)}
    .seg button{
      flex:1; border:0; background:transparent; color: var(--muted);
      padding:10px 12px; font-weight:950; font-size:13px; cursor:pointer; min-height: var(--tap);
      transition: background .25s ease, color .25s ease, transform .05s ease;
    }
    .seg button:active{transform: translateY(1px)}
    .seg button.on{color: var(--text); background: linear-gradient(135deg, rgba(90,169,255,.28), rgba(138,92,255,.26));}

    .content{padding: 12px 14px 0}
    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card + .card{margin-top: 12px}
    .hd{padding:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom: 1px solid var(--line);}
    .hd .h{font-weight:1000; font-size:14px}
    .hd .sub{font-size:12px; color: var(--muted); margin-top:2px}
    .bd{padding:14px}
    .muted{color: var(--muted)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line); background: var(--btnBg); color: var(--text);
      border-radius:14px; padding:12px 12px; font-weight:1000; font-size:13px;
      cursor:pointer; min-height: var(--tap);
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none; flex:1; text-decoration:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, rgba(90,169,255,.92), rgba(138,92,255,.92)); border-color: rgba(255,255,255,.18); color:#fff;}
    body.light .btn.primary{border-color: rgba(15,23,42,.12)}
    .btn.ok{background: rgba(34,197,122,.12); border-color: rgba(34,197,122,.35)}
    .btn.danger{background: rgba(255,75,107,.12); border-color: rgba(255,75,107,.35)}
    .btn.warn{background: rgba(255,204,102,.12); border-color: rgba(255,204,102,.35)}
    .btn.ghost{background: var(--btnGhost)}
    .btn.small{padding:10px 10px; border-radius:12px; font-size:12px; min-height:40px; flex: unset;}

    .search{display:flex; gap:10px; align-items:center}
    .search input{flex:1}
    .pill{
      padding:8px 10px; border:1px solid var(--line); background: var(--glass);
      border-radius:999px; font-size:12px; color: var(--muted); white-space:nowrap;
    }

    label{display:block; font-size:12px; color: var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--inputBg);
      color: var(--text);
      outline:none;
      transition: border-color .2s ease, background .2s ease;
    }
    input:focus, textarea:focus, select:focus{border-color: rgba(90,169,255,.45); background: var(--inputBgFocus)}
    textarea{resize:none}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:380px){.two{grid-template-columns:1fr}}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--line);
      background: var(--itemBg);
      border-radius:16px;
      padding:12px;
      animation: slideIn .22s ease both;
    }
    @keyframes slideIn{from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)}}
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .name{font-weight:1000; font-size:14px; line-height:1.2}
    .meta{margin-top:6px; font-size:12px; color: var(--muted); line-height:1.35}
    .badges{display:flex; flex-direction:column; gap:6px; align-items:flex-end}
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: var(--glass2);
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap; font-weight:900;
    }
    .b-ok{border-color: rgba(34,197,122,.35); background: rgba(34,197,122,.10)}
    .b-warn{border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10)}
    .b-bad{border-color: rgba(255,75,107,.35); background: rgba(255,75,107,.10)}
    .b-paid{border-color: rgba(34,197,122,.45); background: rgba(34,197,122,.14)}
    .b-pend{border-color: rgba(255,204,102,.45); background: rgba(255,204,102,.14)}
    .itemBtns{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

    .tabs{
      position: fixed; left:50%; transform: translateX(-50%); bottom:0;
      width: min(980px, 100%);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index:30;
      backdrop-filter: blur(12px);
      background: var(--tabsBg);
      border-top: 1px solid var(--line);
    }
    @media (min-width: 900px){
      .tabs{ border-radius: 18px 18px 0 0; box-shadow: 0 -12px 30px rgba(0,0,0,.18); }
      body.light .tabs{ box-shadow: 0 -12px 30px rgba(15,23,42,.08); }
    }
    .tabbar{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    .tab{
      border:1px solid var(--line); background: var(--glass2); color: var(--muted);
      border-radius:16px; min-height:52px; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      font-weight:950; font-size:11px;
      transition: background .2s ease, color .2s ease, transform .05s ease, border-color .2s ease;
    }
    .tab:active{transform: translateY(1px)}
    .tab.on{
      color: var(--text);
      border-color: color-mix(in srgb, var(--line) 20%, rgba(255,255,255,.18));
      background: linear-gradient(135deg, rgba(90,169,255,.22), rgba(138,92,255,.18));
    }
    body.light .tab.on{border-color: rgba(15,23,42,.12)}
    .tab .ico{font-size:16px}

    .view{display:none}
    .view.on{display:block}
    .fadeIn{animation: fade .18s ease both}
    @keyframes fade{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

    .back{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:40;
      background: rgba(0,0,0,.62);
    }
    body.light .back{background: rgba(15,23,42,.44)}
    .modal{
      width: min(720px, 100%);
      background: var(--modalBg);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: calc(100vh - 24px);
      display:flex;
      flex-direction:column;
      animation: modalIn .2s ease both;
    }
    @keyframes modalIn{from{opacity:0; transform: translateY(12px) scale(.99)} to{opacity:1; transform: translateY(0) scale(1)}}
    .modal .mhd{padding:14px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px; flex:0 0 auto;}
    .modal .mbd{padding:14px; flex:1 1 auto;}
    .receiptScroll{overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom: 140px;}
    .mActions{
      position: sticky; bottom: 0; z-index: 5;
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: color-mix(in srgb, var(--modalBg) 92%, transparent);
      border-top: 1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    body.light .mActions{border-top-color: rgba(15,23,42,.12)}
    .mActions .btn{flex: 1; min-width: 160px}

    .receipt{
      border-radius:16px; padding:14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, var(--receiptBg1), var(--receiptBg2));
    }
    body.light .receipt{border-color: rgba(15,23,42,.12)}
    .rHeader{display:flex; justify-content:space-between; align-items:flex-start; gap:12px;}
    .rBrand{display:flex; gap:10px; align-items:center; min-width:0;}
    .rLogo{
      width:56px; height:56px; border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      overflow:hidden; flex:0 0 auto; display:grid; place-items:center;
    }
    body.light .rLogo{border-color: rgba(15,23,42,.12); background: rgba(15,23,42,.04)}
    .rLogo img{width:100%; height:100%; object-fit:cover; display:block}
    .rNames{min-width:0}
    .rBiz{font-weight:1000; font-size:15px; line-height:1.15; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .rOwner{margin-top:2px; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .rMeta{text-align:right; display:flex; flex-direction:column; gap:6px; align-items:flex-end;}
    .rTag{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--glass2);
      white-space:nowrap; font-weight:950;
    }
    body.light .rTag{border-color: rgba(15,23,42,.12)}
    .hr{height:1px; background: rgba(255,255,255,.10); margin: 12px 0}
    body.light .hr{background: rgba(15,23,42,.12)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:380px){.grid2{grid-template-columns:1fr}}
    .kv{
      border:1px solid rgba(255,255,255,.10);
      background: color-mix(in srgb, var(--card) 80%, transparent);
      border-radius:14px;
      padding:10px 12px;
    }
    body.light .kv{border-color: rgba(15,23,42,.12)}
    .kv .k{font-size:12px; color: var(--muted)}
    .kv .v{font-size:13px; font-weight:950; margin-top:4px}
    .totalBox{
      margin-top:12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(90,169,255,.16), rgba(138,92,255,.12));
      padding:12px; display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    body.light .totalBox{border-color: rgba(15,23,42,.12)}
    .totalBox .t{color: var(--muted); font-size:12px; font-weight:850}
    .totalBox .amt{font-size:18px; font-weight:1100}
    .pay{
      margin-top:12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--glass2);
      padding:12px; display:flex; gap:12px; align-items:center;
    }
    body.light .pay{border-color: rgba(15,23,42,.12)}
    .qr{
      width:96px; height:96px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      overflow:hidden; flex:0 0 auto; display:grid; place-items:center;
    }
    body.light .qr{border-color: rgba(15,23,42,.12); background: rgba(15,23,42,.04)}
    .qr img{width:100%; height:100%; object-fit:cover; display:block}
    .pay .txt{font-size:12px; color: var(--muted); line-height:1.35}
    .pay .txt b{color: var(--text)}
    .foot{font-size:12px; color: var(--muted); margin-top:12px; line-height:1.45}
    .sign{margin-top:12px; display:flex; justify-content:space-between; gap:10px; align-items:flex-end}
    .sign .lineSign{
      flex:1;
      border-top: 1px dashed rgba(255,255,255,.18);
      padding-top: 10px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }
    body.light .sign .lineSign{border-top-color: rgba(15,23,42,.18)}

    @media print{
      .tabs, .top, .noPrint, .mActions{display:none !important}
      body{background:white !important; color:black !important}
      .back{position: static; display:block; background:transparent !important; padding:0}
      .modal{border:none; box-shadow:none; max-height:none}
      .receipt{border:1px solid #aaa; background:white; color:black}
      .receipt .rOwner, .receipt .foot, .receipt .kv .k, .receipt .pay .txt, .receipt .totalBox .t{color:#333 !important}
      .receipt .kv, .receipt .pay{border-color:#ccc !important; background:#fff !important}
      .receipt .totalBox{border-color:#bbb !important; background:#f6f7fb !important}
    }
  </style>
</head>

<body>
<div class="app">
  <header class="top">
    <div class="bar">
      <div class="brand">
        <div class="logoBox"><img src="./logo.png" alt="Logo"></div>
        <div class="brandTxt">
          <div class="t" id="bizTitle">Control Lucerito</div>
          <div class="s" id="subtitle">Internet ‚Ä¢ TV ‚Ä¢ Clientes</div>
        </div>
      </div>
      <div class="chip">üìÖ <span id="todayLbl"></span></div>
    </div>

    <div class="segWrap noPrint">
      <div class="seg">
        <button id="btnSvcInternet" class="on" type="button">üåê Internet</button>
        <button id="btnSvcTv" type="button">üì∫ Cable/TV</button>
      </div>
      <span class="pill" id="svcPill">Servicio: Internet</span>
    </div>
  </header>

  <main class="content">
    <!-- Inicio -->
    <section id="viewHome" class="view on fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">üìä Resumen</div>
            <div class="sub">Activos, vencidos, por vencer y pagos</div>
          </div>
          <span class="pill" id="totalLbl">0 clientes</span>
        </div>
        <div class="bd">
          <div class="two">
            <div class="item" style="margin:0">
              <div class="name">üü¢ Activos</div>
              <div class="meta"><b id="kActivos">0</b></div>
            </div>
            <div class="item" style="margin:0">
              <div class="name">üî¥ Vencidos</div>
              <div class="meta"><b id="kVencidos">0</b></div>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div class="item" style="margin:0">
              <div class="name">üü° Por vencer (‚â§ 3 d√≠as)</div>
              <div class="meta"><b id="kPorVencer">0</b></div>
            </div>
            <div class="item" style="margin:0">
              <div class="name">üí≥ Pendientes de pago</div>
              <div class="meta"><b id="kPendientesPago">0</b></div>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div class="item" style="margin:0">
              <div class="name">‚úÖ Cancelados</div>
              <div class="meta"><b id="kCancelados">0</b></div>
            </div>
            <div class="item" style="margin:0">
              <div class="name">üë• Total</div>
              <div class="meta"><b id="kTotal">0</b></div>
            </div>
          </div>

          <div class="btnRow noPrint" style="margin-top:14px">
            <button class="btn primary" id="goClients" type="button">üë• Ir a Clientes</button>
            <button class="btn ghost" id="goAdd" type="button">‚ûï Agregar Cliente</button>
          </div>

          <div class="foot">üí° Al agregar: <b>Inicio = hoy</b> y <b>30 d√≠as</b> autom√°tico. Puedes marcar ‚ÄúCancelado‚Äù si pag√≥.</div>
        </div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="viewClients" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">üë• Clientes</div>
            <div class="sub">Lista + acciones r√°pidas</div>
          </div>
          <button class="btn primary small noPrint" id="btnNew" type="button">‚ûï</button>
        </div>

        <div class="bd noPrint">
          <div class="search">
            <input id="q" placeholder="Buscar por nombre, DNI o WhatsApp‚Ä¶" />
            <span class="pill" id="countLbl">0</span>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button class="btn small" id="fAll" type="button">Todos</button>
            <button class="btn small ok" id="fActive" type="button">Activos</button>
            <button class="btn small" id="fSoon" type="button">Por vencer</button>
            <button class="btn small danger" id="fExpired" type="button">Vencidos</button>
            <button class="btn small warn" id="fPayPending" type="button">Pago pendiente</button>
            <button class="btn small ok" id="fPaid" type="button">Cancelados</button>
          </div>

          <div class="foot muted" id="filterLbl" style="margin-top:10px">Filtro: Todos</div>
        </div>

        <div class="bd" style="padding-top: 0">
          <div id="list" class="list"></div>
          <div class="foot muted noPrint">Tip: ‚Äú‚úÖ Pag√≥‚Äù marca cancelado y podr√°s enviar confirmaci√≥n por WhatsApp.</div>
        </div>
      </div>
    </section>

    <!-- Agregar / Editar -->
    <section id="viewAdd" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h" id="addTitle">‚ûï Agregar cliente</div>
            <div class="sub">Inicio = hoy ‚Ä¢ 30 d√≠as autom√°tico</div>
          </div>
          <button class="btn small noPrint" id="btnBackClients" type="button">‚Ü©Ô∏è</button>
        </div>

        <div class="bd">
          <form id="clientForm">
            <input type="hidden" id="clientId" />

            <label>Nombre</label>
            <input id="nombre" required placeholder="Ej: Juan P√©rez" />

            <div class="two">
              <div>
                <label>DNI</label>
                <input id="dni" inputmode="numeric" placeholder="Ej: 12345678" />
              </div>
              <div>
                <label>WhatsApp (c√≥digo pa√≠s)</label>
                <input id="whatsapp" inputmode="tel" placeholder="Ej: 51987654321" />
              </div>
            </div>

            <label>Plan / Servicio</label>
            <input id="plan" placeholder="Ej: Internet 50 Mbps / Cable HD" />

            <div class="two">
              <div>
                <label>Precio (S/)</label>
                <input id="precio" inputmode="decimal" placeholder="Ej: 60" />
              </div>
              <div>
                <label>D√≠as pagados</label>
                <input id="diasPagados" type="number" min="1" step="1" />
              </div>
            </div>

            <div class="two">
              <div>
                <label>Inicio (auto)</label>
                <input id="inicio" type="date" required />
              </div>
              <div>
                <label>Vence</label>
                <input id="vencePreview" disabled />
              </div>
            </div>

            <div class="two">
              <div>
                <label>Estado de pago</label>
                <select id="pagoEstado">
                  <option value="pending">üü° Pendiente</option>
                  <option value="paid">‚úÖ Cancelado</option>
                </select>
              </div>
              <div>
                <label>Fecha de pago (si cancel√≥)</label>
                <input id="pagoFecha" type="date" />
              </div>
            </div>

            <label>Notas</label>
            <textarea id="notas" rows="2" placeholder="Direcci√≥n, referencia, etc."></textarea>

            <div class="btnRow noPrint">
              <button class="btn primary" type="submit">üíæ Guardar</button>
              <button class="btn ghost" type="button" id="btnClear">üßº Limpiar</button>
            </div>

            <div class="btnRow noPrint">
              <button class="btn ok" type="button" id="btnReceiptFromForm" style="display:none">üßæ Ver Recibo</button>
              <button class="btn ok" type="button" id="btnConfirmPaidFromForm" style="display:none">‚úÖ Confirmaci√≥n WA</button>
              <button class="btn danger" type="button" id="btnDelete" style="display:none">üóëÔ∏è Eliminar</button>
            </div>

            <div class="foot muted">‚úÖ Estado del servicio depende de vencimiento. El ‚ÄúPago‚Äù es aparte (pendiente/cancelado).</div>
          </form>
        </div>
      </div>
    </section>

    <!-- Ajustes -->
    <section id="viewSettings" class="view fadeIn">
      <div class="card">
        <div class="hd">
          <div>
            <div class="h">‚öôÔ∏è Ajustes</div>
            <div class="sub">Tema + Guardado en l√≠nea</div>
          </div>
        </div>

        <div class="bd noPrint">
          <div class="item" style="margin:0">
            <div class="itemTop">
              <div>
                <div class="name">üé® Tema</div>
                <div class="meta">Cambia entre <b>Oscuro</b> y <b>Blanco</b>.</div>
              </div>
              <div class="badges"><span class="badge" id="themeBadge">üåô Oscuro</span></div>
            </div>
            <div class="btnRow" style="margin-top:10px">
              <button class="btn" id="btnThemeToggle" type="button">Cambiar tema</button>
            </div>
          </div>

          <div class="item" style="margin-top:12px">
            <div class="itemTop">
              <div>
                <div class="name">‚òÅÔ∏è Guardado en l√≠nea (Gratis)</div>
                <div class="meta">
                  Se guarda en la nube con Firebase (Google). Sincroniza entre celular y PC.
                  <br><span class="muted">Nota: se guarda tambi√©n una copia local como ‚Äúcache‚Äù por si est√°s sin internet.</span>
                </div>
              </div>
              <div class="badges">
                <span class="badge" id="cloudBadge">OFF</span>
                <span class="badge" id="cloudStateBadge">üî¥ Offline</span>
              </div>
            </div>
            <div class="btnRow" style="margin-top:10px">
              <button class="btn" id="btnCloudToggle" type="button">Activar / Desactivar</button>
              <button class="btn ok" id="btnCloudSyncNow" type="button">Sincronizar ahora</button>
            </div>
          </div>

          <div class="item" style="margin-top:12px">
            <div class="itemTop">
              <div>
                <div class="name">üß∞ Exportar / Importar (opcional)</div>
                <div class="meta">Por si alg√∫n d√≠a quieres guardar un respaldo manual.</div>
              </div>
            </div>
            <div class="btnRow" style="margin-top:10px">
              <button class="btn ok" id="btnExport" type="button">‚¨áÔ∏è Exportar</button>
              <button class="btn" id="btnImport" type="button">‚¨ÜÔ∏è Importar</button>
            </div>
            <input type="file" id="importFile" accept="application/json" hidden />
          </div>

          <div class="btnRow">
            <button class="btn danger" id="btnReset" type="button">üß® Borrar todo</button>
          </div>

          <div class="foot">
            üìå Recibo: <b>Jos√© Lucero</b> ‚Ä¢ <b>+51 995 218 023</b> ‚Ä¢ QR Yape.
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Tabs -->
<nav class="tabs noPrint" aria-label="Navegaci√≥n">
  <div class="tabbar">
    <button class="tab on" data-tab="home" type="button"><div class="ico">üè†</div><div>Inicio</div></button>
    <button class="tab" data-tab="clients" type="button"><div class="ico">üë•</div><div>Clientes</div></button>
    <button class="tab" data-tab="add" type="button"><div class="ico">‚ûï</div><div>Agregar</div></button>
    <button class="tab" data-tab="settings" type="button"><div class="ico">‚öôÔ∏è</div><div>Ajustes</div></button>
  </div>
</nav>

<!-- Modal Recibo -->
<div class="back" id="back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <div style="font-weight:1000">üßæ Recibo</div>
      <div class="noPrint" style="opacity:.9; font-size:12px; color: var(--muted);">Acciones abajo</div>
    </div>

    <div class="mbd receiptScroll">
      <div class="receipt" id="receiptBox"></div>
    </div>

    <div class="mActions noPrint">
      <button class="btn small" id="btnPrint" type="button">üñ®Ô∏è Imprimir</button>
      <a class="btn small ok" id="btnWA" target="_blank" rel="noopener">üü¢ WhatsApp Recibo</a>
      <a class="btn small ok" id="btnWAPaid" target="_blank" rel="noopener">‚úÖ Confirmaci√≥n Pago</a>
      <button class="btn small danger" id="btnClose" type="button">‚úñÔ∏è Cerrar</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Firebase SDK (CDN modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, getDocs, onSnapshot,
    serverTimestamp, deleteDoc, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ‚úÖ PEGA AQU√ç TU firebaseConfig (Firebase Console ‚Üí Project settings ‚Üí Web app)
  const firebaseConfig = {
  apiKey: "AIzaSyA4HSOPzJktjMMSgo_XDx11-gRzziGoyXc",
  authDomain: "control-lucerito.firebaseapp.com",
  projectId: "control-lucerito",
  storageBucket: "control-lucerito.appspot.com",
  messagingSenderId: "916591504111",
  appId: "1:916591504111:web:e82096db30317c8b48891a"
};
// üî• INICIALIZAR FIREBASE
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
  window.__CLOUD__ = {
    initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
    getFirestore, collection, doc, setDoc, getDocs, onSnapshot,
    serverTimestamp, deleteDoc, writeBatch,
    firebaseConfig
  };
</script>

<script>
  // üî®ü§ñüîß Control Lucerito v8 (Cloud Save Gratis con Firebase)

  const BUSINESS_NAME = "Control Lucerito";
  const OWNER_NAME = "Jos√© Lucero";
  const OWNER_PHONE = "+51 995 218 023";
  const YAPE_PHONE = OWNER_PHONE;

  const KEYS = {
    data: "lucerito_data_v8",
    receiptCounter: "lucerito_receipt_counter_v1",
    theme: "lucerito_theme_v1",
    cloud: "lucerito_cloud_v1" // 'on' | 'off'
  };

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const el = {
    todayLbl: $("#todayLbl"),
    subtitle: $("#subtitle"),
    bizTitle: $("#bizTitle"),
    svcPill: $("#svcPill"),

    btnSvcInternet: $("#btnSvcInternet"),
    btnSvcTv: $("#btnSvcTv"),

    tabs: $$(".tab"),

    kActivos: $("#kActivos"),
    kVencidos: $("#kVencidos"),
    kPorVencer: $("#kPorVencer"),
    kPendientesPago: $("#kPendientesPago"),
    kCancelados: $("#kCancelados"),
    kTotal: $("#kTotal"),
    totalLbl: $("#totalLbl"),

    goClients: $("#goClients"),
    goAdd: $("#goAdd"),

    btnNew: $("#btnNew"),
    q: $("#q"),
    list: $("#list"),
    countLbl: $("#countLbl"),
    filterLbl: $("#filterLbl"),
    fAll: $("#fAll"),
    fActive: $("#fActive"),
    fSoon: $("#fSoon"),
    fExpired: $("#fExpired"),
    fPayPending: $("#fPayPending"),
    fPaid: $("#fPaid"),

    addTitle: $("#addTitle"),
    btnBackClients: $("#btnBackClients"),
    form: $("#clientForm"),
    clientId: $("#clientId"),
    nombre: $("#nombre"),
    dni: $("#dni"),
    whatsapp: $("#whatsapp"),
    plan: $("#plan"),
    precio: $("#precio"),
    diasPagados: $("#diasPagados"),
    inicio: $("#inicio"),
    vencePreview: $("#vencePreview"),
    notas: $("#notas"),
    pagoEstado: $("#pagoEstado"),
    pagoFecha: $("#pagoFecha"),
    btnClear: $("#btnClear"),
    btnDelete: $("#btnDelete"),
    btnReceiptFromForm: $("#btnReceiptFromForm"),
    btnConfirmPaidFromForm: $("#btnConfirmPaidFromForm"),

    btnThemeToggle: $("#btnThemeToggle"),
    themeBadge: $("#themeBadge"),

    cloudBadge: $("#cloudBadge"),
    cloudStateBadge: $("#cloudStateBadge"),
    btnCloudToggle: $("#btnCloudToggle"),
    btnCloudSyncNow: $("#btnCloudSyncNow"),

    btnExport: $("#btnExport"),
    btnImport: $("#btnImport"),
    importFile: $("#importFile"),
    btnReset: $("#btnReset"),

    back: $("#back"),
    receiptBox: $("#receiptBox"),
    btnClose: $("#btnClose"),
    btnPrint: $("#btnPrint"),
    btnWA: $("#btnWA"),
    btnWAPaid: $("#btnWAPaid"),
  };

  /** @typedef {'internet'|'tv'} Service */
  /** @typedef {'all'|'active'|'soon'|'expired'|'payPending'|'paid'} Filter */
  /** @typedef {{ no:number, vence:string, createdAt:number }} LastReceipt */
  /** @typedef {{
    id:string,
    service:Service,
    nombre:string,
    dni:string,
    whatsapp:string,
    plan:string,
    precio:number,
    inicio:string,
    diasPagados:number,
    notas:string,
    paid:boolean,
    paidAt:string,
    lastReceipt?:LastReceipt,
    createdAt:number,
    updatedAt:number
  }} Client */

  const state = {
    service: /** @type {Service} */ ("internet"),
    filter: /** @type {Filter} */ ("all"),
    clients: /** @type {Client[]} */ ([]),
    selectedId: null,

    theme: /** @type {'dark'|'light'} */ ("dark"),
    cloud: /** @type {'on'|'off'} */ ("off"),

    cloudReady: false,
    cloudUid: "",
    cloudUnsub: null,
    __fb: null,
    cloudBusy: false,
  };

  // ===== THEME =====
  function applyTheme(theme){
    state.theme = theme;
    document.body.classList.toggle("light", theme === "light");
    el.themeBadge.textContent = theme === "light" ? "‚òÄÔ∏è Blanco" : "üåô Oscuro";
    localStorage.setItem(KEYS.theme, theme);
  }
  function toggleTheme(){ applyTheme(state.theme === "light" ? "dark" : "light"); }

  // ===== Cloud badges =====
  function setCloudBadge(on){
    el.cloudBadge.textContent = on ? "ON" : "OFF";
    el.cloudBadge.className = "badge " + (on ? "b-ok" : "");
  }
  function setCloudState(text, ok){
    el.cloudStateBadge.textContent = text;
    el.cloudStateBadge.className = "badge " + (ok ? "b-ok" : "b-bad");
  }

  // ===== Dates =====
  const pad2 = (n) => String(n).padStart(2, "0");
  const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const todayISO = () => toISODate(new Date());
  const parseISO = (iso) => {
    const [y,m,d] = iso.split("-").map(Number);
    return new Date(y, m-1, d, 12, 0, 0);
  };
  const addDays = (iso, days) => {
    const d = parseISO(iso);
    d.setDate(d.getDate() + Number(days || 0));
    return toISODate(d);
  };
  const diffDays = (fromISO, toISO) => {
    const a = parseISO(fromISO).getTime();
    const b = parseISO(toISO).getTime();
    return Math.round((b - a) / (1000*60*60*24));
  };
  const formatDate = (iso) => {
    const d = parseISO(iso);
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  };

// ===== Utils =====
  const uid = () => "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const normalizePhone = (p) => (p || "").replace(/[^\d]/g, "");
  const money = (n) => {
    const v = Number(n || 0);
    if (!isFinite(v)) return "0";
    return v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  };

  // ===== Local cache =====
  function loadLocal(){
    try{
      const raw = localStorage.getItem(KEYS.data);
      const arr = raw ? JSON.parse(raw) : [];
      state.clients = Array.isArray(arr) ? arr : [];
    }catch{ state.clients = []; }
  }
  function saveLocal(){
    localStorage.setItem(KEYS.data, JSON.stringify(state.clients));
  }

  // ===== Cloud (Firebase) =====
  function applyCloud(v){
    state.cloud = v;
    localStorage.setItem(KEYS.cloud, v);
    setCloudBadge(v === "on");
  }

  function cloudPathClients(){
    return `users/${state.cloudUid}/clients`;
  }

  async function cloudInitIfNeeded(){
    if (state.cloudReady) return true;
    if (!window.__CLOUD__) {
      alert("Firebase no carg√≥. Revisa internet o el firebaseConfig.");
      return false;
    }

    const C = window.__CLOUD__;
    // Detecta si config sigue con "TU_..."
    const cfg = C.firebaseConfig || {};
    const bad = Object.values(cfg).some(v => String(v||"").includes("TU_"));
    if (bad){
      alert("Falta pegar tu firebaseConfig en el index.html (Firebase Console).");
      return false;
    }

    const app = C.initializeApp(cfg);
    const auth = C.getAuth(app);
    const db = C.getFirestore(app);

    state.__fb = { C, app, auth, db };

    return new Promise((resolve) => {
      C.onAuthStateChanged(auth, async (user) => {
        try{
          if (!user) await C.signInAnonymously(auth);
          else{
            state.cloudUid = user.uid;
            state.cloudReady = true;
            setCloudState("üü¢ Conectado", true);
            resolve(true);
          }
        }catch(err){
          console.error(err);
          setCloudState("üî¥ Error", false);
          resolve(false);
        }
      });
    });
  }

  async function cloudDownloadToLocal(){
    const ok = await cloudInitIfNeeded();
    if (!ok) return;

    const { C, db } = state.__fb;
    const colRef = C.collection(db, cloudPathClients());
    const snap = await C.getDocs(colRef);

    const arr = [];
    snap.forEach(d => arr.push(d.data()));
    state.clients = Array.isArray(arr) ? arr : [];
    saveLocal();
    renderAll();
  }

  async function cloudUploadAll(){
    const ok = await cloudInitIfNeeded();
    if (!ok) return;

    const { C, db } = state.__fb;
    const colRef = C.collection(db, cloudPathClients());

    // estrategia simple y segura: borrar remoto y subir local
    const remoteSnap = await C.getDocs(colRef);
    const batch = C.writeBatch(db);

    remoteSnap.forEach(d => batch.delete(d.ref));
    for (const c of state.clients){
      const ref = C.doc(db, cloudPathClients() + "/" + c.id);
      batch.set(ref, { ...c, _updatedAtServer: C.serverTimestamp() }, { merge: true });
    }
    await batch.commit();
  }

  function cloudLiveSubscribe(){
    if (!state.__fb) return;
    if (state.cloudUnsub) { state.cloudUnsub(); state.cloudUnsub = null; }

    const { C, db } = state.__fb;
    const colRef = C.collection(db, cloudPathClients());

    state.cloudUnsub = C.onSnapshot(colRef, (snap) => {
      const arr = [];
      snap.forEach(d => arr.push(d.data()));
      state.clients = Array.isArray(arr) ? arr : [];
      saveLocal();     // cache local
      renderAll();
    });
  }

  async function cloudUpsertOne(client){
    const ok = await cloudInitIfNeeded();
    if (!ok) return;

    const { C, db } = state.__fb;
    const ref = C.doc(db, cloudPathClients() + "/" + client.id);
    await C.setDoc(ref, { ...client, _updatedAtServer: C.serverTimestamp() }, { merge: true });
  }

  async function cloudDeleteOne(id){
    const ok = await cloudInitIfNeeded();
    if (!ok) return;

    const { C, db } = state.__fb;
    const ref = C.doc(db, cloudPathClients() + "/" + id);
    await C.deleteDoc(ref);
  }

  // ‚úÖ Guardado inteligente: siempre cache local y si cloud ON ‚Üí sync cloud
  async function saveSmart(reason, payload){
    saveLocal();

    if (state.cloud !== "on") return;
    if (state.cloudBusy) return; // evita spam
    state.cloudBusy = true;

    try{
      if (reason === "reset" || reason === "import"){
        await cloudUploadAll();
      } else if (reason === "delete"){
        if (payload?.id) await cloudDeleteOne(payload.id);
        else await cloudUploadAll();
      } else {
        if (payload?.client) await cloudUpsertOne(payload.client);
        else await cloudUploadAll();
      }
    } catch (e){
      console.error(e);
      // queda cache local, no se pierde
    } finally {
      state.cloudBusy = false;
    }
  }

  // ===== Business logic =====
  function compute(client){
    const vence = addDays(client.inicio, client.diasPagados);
    const hoy = todayISO();
    const daysLeft = diffDays(hoy, vence);
    const isActive = daysLeft >= 0;
    const isSoon = isActive && daysLeft <= 3;
    const isExpired = !isActive;
    return { vence, hoy, daysLeft, isActive, isSoon, isExpired };
  }

  function serviceBadge(st){
    if (st.isExpired) return `<span class="badge b-bad">üî¥ Vencido</span>`;
    if (st.isSoon) return `<span class="badge b-warn">üü° Por vencer</span>`;
    return `<span class="badge b-ok">üü¢ Activo</span>`;
  }
  function paymentBadge(c){
    if (c.paid) return `<span class="badge b-paid">‚úÖ Cancelado</span>`;
    return `<span class="badge b-pend">üü° Pago pendiente</span>`;
  }
  function daysText(st){
    if (st.isExpired) return `Venci√≥ hace <b>${Math.abs(st.daysLeft)}</b> d√≠a(s)`;
    return `Le quedan <b>${st.daysLeft}</b> d√≠a(s)`;
  }

  function applyService(list){ return list.filter(c => c.service === state.service); }

  function applyFilter(list){
    const q = el.q.value.trim().toLowerCase();
    let out = list;

    if (q){
      out = out.filter(c => (c.nombre + " " + c.dni + " " + c.whatsapp).toLowerCase().includes(q));
    }

    out = out.filter(c => {
      const st = compute(c);
      if (state.filter === "active") return st.isActive;
      if (state.filter === "soon") return st.isSoon;
      if (state.filter === "expired") return st.isExpired;
      if (state.filter === "payPending") return !c.paid;
      if (state.filter === "paid") return !!c.paid;
      return true;
    });

    out.sort((a,b) => {
      const A = compute(a), B = compute(b);
      if (A.isExpired !== B.isExpired) return A.isExpired ? -1 : 1;
      if (A.isSoon !== B.isSoon) return A.isSoon ? -1 : 1;
      if (a.paid !== b.paid) return a.paid ? 1 : -1; // pendientes arriba
      if (A.daysLeft !== B.daysLeft) return A.daysLeft - B.daysLeft;
      return (a.nombre || "").localeCompare(b.nombre || "");
    });

    return out;
  }

  // ===== Tabs =====
  function setTab(tab){
    $$(".tab").forEach(t => t.classList.toggle("on", t.dataset.tab === tab));
    $("#viewHome").classList.toggle("on", tab === "home");
    $("#viewClients").classList.toggle("on", tab === "clients");
    $("#viewAdd").classList.toggle("on", tab === "add");
    $("#viewSettings").classList.toggle("on", tab === "settings");

    const svcTxt = state.service === "internet" ? "Internet" : "Cable/TV";
    if (tab === "home") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Resumen`;
    if (tab === "clients") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Clientes`;
    if (tab === "add") el.subtitle.textContent = `${svcTxt} ‚Ä¢ Agregar/Editar`;
    if (tab === "settings") el.subtitle.textContent = `Panel ‚Ä¢ Ajustes`;

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function setService(svc){
    state.service = svc;
    el.btnSvcInternet.classList.toggle("on", svc === "internet");
    el.btnSvcTv.classList.toggle("on", svc === "tv");
    el.svcPill.textContent = "Servicio: " + (svc === "internet" ? "Internet" : "Cable/TV");
    el.plan.placeholder = svc === "internet" ? "Ej: Internet 50 Mbps" : "Ej: Cable HD";
    el.q.value = "";
    setFilter("all", false);
    renderAll();
  }

  function setFilter(f, rerender=true){
    state.filter = f;
    if (rerender) renderList();
  }

  function updateVencePreview(){
    const inicio = el.inicio.value || todayISO();
    const dias = Number(el.diasPagados.value || 30);
    const vence = addDays(inicio, dias);
    el.vencePreview.value = formatDate(vence);
  }

  function newClientForm(){
    state.selectedId = null;
    el.clientId.value = "";
    el.addTitle.textContent = "‚ûï Agregar cliente";
    el.nombre.value = "";
    el.dni.value = "";
    el.whatsapp.value = "";
    el.plan.value = "";
    el.precio.value = "";
    el.notas.value = "";
    el.inicio.value = todayISO();
    el.diasPagados.value = 30;
    el.pagoEstado.value = "pending";
    el.pagoFecha.value = "";
    updateVencePreview();
    el.btnDelete.style.display = "none";
    el.btnReceiptFromForm.style.display = "none";
    el.btnConfirmPaidFromForm.style.display = "none";
  }

  function fillForm(client){
    state.selectedId = client.id;
    el.clientId.value = client.id;
    el.addTitle.textContent = "‚úèÔ∏è Editar cliente";
    el.nombre.value = client.nombre || "";
    el.dni.value = client.dni || "";
    el.whatsapp.value = client.whatsapp || "";
    el.plan.value = client.plan || "";
    el.precio.value = (client.precio ?? "") === 0 ? "0" : String(client.precio ?? "");
    el.notas.value = client.notas || "";
    el.inicio.value = client.inicio || todayISO();
    el.diasPagados.value = String(client.diasPagados ?? 30);

    el.pagoEstado.value = client.paid ? "paid" : "pending";
    el.pagoFecha.value = client.paidAt || "";

    updateVencePreview();
    el.btnDelete.style.display = "inline-flex";
    el.btnReceiptFromForm.style.display = "inline-flex";
    el.btnConfirmPaidFromForm.style.display = client.paid ? "inline-flex" : "none";
  }

  async function upsertFromForm(){
    const id = el.clientId.value || uid();
    const now = Date.now();

    const nombre = el.nombre.value.trim();
    const dni = el.dni.value.trim();
    const whatsapp = normalizePhone(el.whatsapp.value.trim());
    const plan = el.plan.value.trim();
    const precio = Number(String(el.precio.value).replace(",", "."));
    const inicio = el.inicio.value || todayISO();
    const diasPagados = Number(el.diasPagados.value || 30);
    const notas = el.notas.value.trim();

    const paid = el.pagoEstado.value === "paid";
    const paidAt = paid ? (el.pagoFecha.value || todayISO()) : "";

    if (!nombre) return alert("Falta el nombre.");
    if (!diasPagados || diasPagados < 1) return alert("D√≠as pagados debe ser m√≠nimo 1.");

    const existing = state.clients.find(c => c.id === id);

    /** @type {Client} */
    const client = existing ? { ...existing } : ({
      id,
      service: state.service,
      nombre: "",
      dni: "",
      whatsapp: "",
      plan: "",
      precio: 0,
      inicio: todayISO(),
      diasPagados: 30,
      notas: "",
      paid: false,
      paidAt: "",
      createdAt: now,
      updatedAt: now
    });

 client.service = state.service;
    client.nombre = nombre;
    client.dni = dni;
    client.whatsapp = whatsapp;
    client.plan = plan || (state.service === "internet" ? "Internet" : "Cable/TV");
    client.precio = isFinite(precio) ? precio : 0;
    client.inicio = inicio;
    client.diasPagados = diasPagados;
    client.notas = notas;
    client.paid = paid;
    client.paidAt = paidAt;
    client.updatedAt = now;

    if (!existing) state.clients.push(client);
    else state.clients = state.clients.map(c => c.id === id ? client : c);

    await saveSmart("save", { client });
    renderAll();
    fillForm(client);
    navigator.vibrate?.(25);
    alert("Guardado ‚úÖ");
  }

  async function removeClient(id){
    const client = state.clients.find(c => c.id === id);
    if (!client) return;
    if (!confirm(`¬øEliminar a "${client.nombre}"?`)) return;

    state.clients = state.clients.filter(c => c.id !== id);
    await saveSmart("delete", { id });
    renderAll();
    newClientForm();
    setTab("clients");
  }

  async function markPaid(id, paid){
    const client = state.clients.find(c => c.id === id);
    if (!client) return;
    client.paid = paid;
    client.paidAt = paid ? (client.paidAt || todayISO()) : "";
    client.updatedAt = Date.now();
    state.clients = state.clients.map(c => c.id === id ? client : c);

    await saveSmart("paid_toggle", { client });
    renderAll();
    if (state.selectedId === id) fillForm(client);
  }

  // ===== Receipt numbers =====
  function nextReceiptNo(){
    const cur = Number(localStorage.getItem(KEYS.receiptCounter) || "0");
    const next = cur + 1;
    localStorage.setItem(KEYS.receiptCounter, String(next));
    return next;
  }
  const formatReceiptNo = (n) => String(n).padStart(4, "0");

  function buildReceipt(client){
    const st = compute(client);
    const fecha = todayISO();
    const svcName = client.service === "internet" ? "INTERNET" : "CABLE/TV";

    let receiptNo;
    if (client.lastReceipt && client.lastReceipt.vence === st.vence) receiptNo = client.lastReceipt.no;
    else {
      receiptNo = nextReceiptNo();
      client.lastReceipt = { no: receiptNo, vence: st.vence, createdAt: Date.now() };
      state.clients = state.clients.map(c => c.id === client.id ? client : c);
      saveLocal(); // correlativo local (no afecta cloud)
    }
    const receiptNoTxt = formatReceiptNo(receiptNo);

    const estadoServicioTxt = st.isExpired ? "VENCIDO" : (st.isSoon ? "POR VENCER" : "ACTIVO");
    const estadoPagoTxt = client.paid ? `CANCELADO${client.paidAt ? ` (${formatDate(client.paidAt)})` : ""}` : "PAGO PENDIENTE";

    const msgReceipt = [
      `üßæ *RECIBO N¬∞ ${receiptNoTxt}*`,
      `*${BUSINESS_NAME}*`,
      `Atiende: ${OWNER_NAME} (${OWNER_PHONE})`,
      ``,
      `üë§ *Cliente:* ${client.nombre}${client.dni ? `\nü™™ *DNI:* ${client.dni}` : ""}`,
      `üìå *Servicio:* ${svcName}`,
      `üì∂ *Plan:* ${client.plan}`,
      ``,
      `üìÖ *Inicio:* ${formatDate(client.inicio)}`,
      `‚è≥ *Vence:* ${formatDate(st.vence)}`,
      `üóìÔ∏è *D√≠as pagados:* ${client.diasPagados}`,
      ``,
      `üí∞ *Total:* S/ ${money(client.precio)}`,
      `üìç *Estado servicio:* ${estadoServicioTxt}`,
      st.isExpired ? `‚ö†Ô∏è Venci√≥ hace ${Math.abs(st.daysLeft)} d√≠a(s).` : `‚úÖ Le quedan ${st.daysLeft} d√≠a(s).`,
      `üí≥ *Estado pago:* ${client.paid ? "‚úÖ CANCELADO" : "üü° PENDIENTE"}`,
      ``,
      `üí≥ *Yape:* ${YAPE_PHONE}`,
      `üì∑ Enviar captura por WhatsApp para confirmar.`,
      ``,
      `Gracias por tu preferencia üôå`
    ].join("\n");

    const msgPaid = [
      `‚úÖ *PAGO RECIBIDO*`,
      `*${BUSINESS_NAME}*`,
      `Atiende: ${OWNER_NAME} (${OWNER_PHONE})`,
      ``,
      `üë§ *Cliente:* ${client.nombre}`,
      `üìå *Servicio:* ${svcName}`,
      `üì∂ *Plan:* ${client.plan}`,
      `üí∞ *Monto:* S/ ${money(client.precio)}`,
      `üìÖ *Fecha de pago:* ${client.paidAt ? formatDate(client.paidAt) : formatDate(todayISO())}`,
      `‚è≥ *Vence:* ${formatDate(st.vence)}`,
      ``,
      `Gracias por cancelar üôå`
    ].join("\n");

    const phone = normalizePhone(client.whatsapp);
    const waReceiptUrl = phone ? `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(msgReceipt)}` : null;
    const waPaidUrl = (phone && client.paid) ? `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(msgPaid)}` : null;

    const payStateBadge = client.paid ? `<span class="badge b-paid">‚úÖ Cancelado</span>` : `<span class="badge b-pend">üü° Pendiente</span>`;
    const payInfo = client.paid ? (client.paidAt ? `Pag√≥: <b>${formatDate(client.paidAt)}</b>` : `Pag√≥ ‚úÖ`) : `Deuda: <b>S/ ${money(client.precio)}</b>`;

    const html = `
      <div class="rHeader">
        <div class="rBrand">
          <div class="rLogo"><img src="./logo.png" alt="Logo"></div>
          <div class="rNames">
            <div class="rBiz">${escapeHtml(BUSINESS_NAME)}</div>
            <div class="rOwner">${escapeHtml(OWNER_NAME)} ‚Ä¢ ${escapeHtml(OWNER_PHONE)}</div>
          </div>
        </div>
        <div class="rMeta">
          <div class="rTag">Recibo N¬∞ ${receiptNoTxt}</div>
          <div class="rTag">${formatDate(fecha)}</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="kv"><div class="k">Cliente</div><div class="v">${escapeHtml(client.nombre)}</div></div>
        <div class="kv"><div class="k">Servicio</div><div class="v">${svcName}</div></div>

        <div class="kv"><div class="k">Plan</div><div class="v">${escapeHtml(client.plan)}</div></div>
        <div class="kv"><div class="k">Estado (servicio)</div><div class="v">${estadoServicioTxt} ‚Ä¢ ${daysText(st)}</div></div>

        <div class="kv"><div class="k">Inicio</div><div class="v">${formatDate(client.inicio)}</div></div>
        <div class="kv"><div class="k">Vence</div><div class="v">${formatDate(st.vence)}</div></div>

        <div class="kv"><div class="k">Pago</div><div class="v">${estadoPagoTxt}<br><span class="muted">${payInfo}</span></div></div>
        <div class="kv"><div class="k">Contacto</div><div class="v">${client.whatsapp ? escapeHtml(client.whatsapp) : "‚Äî"}</div></div>

        ${client.dni ? `<div class="kv" style="grid-column: 1 / -1;"><div class="k">DNI</div><div class="v">${escapeHtml(client.dni)}</div></div>` : ""}
      </div>

      <div class="totalBox">
        <div><div class="t">Total</div><div class="t">(${svcName})</div></div>
        <div class="amt">S/ ${money(client.precio)}</div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        ${serviceBadge(st)}
        ${payStateBadge}
      </div>

      <div class="pay">
        <div class="qr"><img src="./qr-yape.png" alt="QR Yape"></div>
        <div class="txt">
          <div style="font-weight:1000; color: var(--text)">Pago por Yape</div>
          Escanea el QR o transfiere al n√∫mero:<br>
          <b>${escapeHtml(YAPE_PHONE)}</b><br>
          <span class="muted">Luego env√≠a captura por WhatsApp para confirmar.</span>
        </div>
      </div>

      <div class="foot">
        ${client.notas ? `<b>Notas:</b> ${escapeHtml(client.notas)}<br>` : ""}
        <b>Atenci√≥n:</b> ${escapeHtml(OWNER_NAME)} ‚Ä¢ ${escapeHtml(OWNER_PHONE)}<br>
        Gracias por tu preferencia üôå
      </div>

      <div class="sign">
        <div class="lineSign">Firma / Sello</div>
        <div class="lineSign">Cliente</div>
      </div>
    `;

    return { html, waReceiptUrl, waPaidUrl };
  }

  function openReceipt(id){
    const client = state.clients.find(c => c.id === id);
    if (!client) return;

    const r = buildReceipt(client);
    el.receiptBox.innerHTML = r.html;

    const phone = normalizePhone(client.whatsapp);
    if (!phone){
      el.btnWA.href = "#"; el.btnWA.style.opacity = ".6"; el.btnWA.style.pointerEvents = "none";
      el.btnWAPaid.href = "#"; el.btnWAPaid.style.opacity = ".6"; el.btnWAPaid.style.pointerEvents = "none";
      alert("Este cliente no tiene WhatsApp. Agrega el n√∫mero con c√≥digo pa√≠s (ej: 519xxxxxxxx).");
    } else {
      el.btnWA.href = r.waReceiptUrl; el.btnWA.style.opacity = "1"; el.btnWA.style.pointerEvents = "auto";
      if (r.waPaidUrl){
        el.btnWAPaid.href = r.waPaidUrl; el.btnWAPaid.style.opacity = "1"; el.btnWAPaid.style.pointerEvents = "auto";
      } else {
        el.btnWAPaid.href = "#"; el.btnWAPaid.style.opacity = ".6"; el.btnWAPaid.style.pointerEvents = "none";
      }
    }
    el.back.style.display = "flex";
  }
  function closeReceipt(){ el.back.style.display = "none"; }

  function waPaidConfirmation(id){
    const c = state.clients.find(x => x.id === id);
    if (!c) return;
    if (!c.paid) return alert("Primero marca como ‚úÖ Cancelado para enviar confirmaci√≥n.");
    const phone = normalizePhone(c.whatsapp);
    if (!phone) return alert("Este cliente no tiene WhatsApp.");
    const st = compute(c);
    const svcName = c.service === "internet" ? "INTERNET" : "CABLE/TV";
    const msg = [
      `‚úÖ *PAGO RECIBIDO*`,
      `*${BUSINESS_NAME}*`,
      `Atiende: ${OWNER_NAME} (${OWNER_PHONE})`,
      ``,
      `üë§ *Cliente:* ${c.nombre}`,
      `üìå *Servicio:* ${svcName}`,
      `üì∂ *Plan:* ${c.plan}`,
      `üí∞ *Monto:* S/ ${money(c.precio)}`,
      `üìÖ *Fecha de pago:* ${c.paidAt ? formatDate(c.paidAt) : formatDate(todayISO())}`,
      `‚è≥ *Vence:* ${formatDate(st.vence)}`,
      ``,
      `Gracias por cancelar üôå`
    ].join("\n");
    const url = `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank", "noopener");
  }

  // ===== Render =====
  function renderKPIs(){
    const list = applyService(state.clients);
    let activos=0, vencidos=0, porVencer=0, pendientesPago=0, cancelados=0;

    for (const c of list){
      const st = compute(c);
      if (st.isExpired) vencidos++; else activos++;
      if (st.isSoon) porVencer++;
      if (c.paid) cancelados++; else pendientesPago++;
    }
    el.kActivos.textContent = String(activos);
    el.kVencidos.textContent = String(vencidos);
    el.kPorVencer.textContent = String(porVencer);
    el.kPendientesPago.textContent = String(pendientesPago);
    el.kCancelados.textContent = String(cancelados);
    el.kTotal.textContent = String(list.length);
    el.totalLbl.textContent = `${list.length} clientes`;
  }

  function renderList(){
    const svcList = applyService(state.clients);
    const filtered = applyFilter(svcList);
    el.countLbl.textContent = String(filtered.length);

    const map = { all:"Todos", active:"Activos", soon:"Por vencer", expired:"Vencidos", payPending:"Pago pendiente", paid:"Cancelados" };
    el.filterLbl.textContent = `Filtro: ${map[state.filter]}`;

    if (filtered.length === 0){
      el.list.innerHTML = `
        <div class="item">
          <div class="name">No hay clientes aqu√≠ üòÖ</div>
          <div class="meta">Toca ‚Äú‚ûï‚Äù para agregar uno.</div>
        </div>`;
      return;
    }

    el.list.innerHTML = filtered.map(c => {
      const st = compute(c);
      const venceTxt = formatDate(st.vence);
      const inicioTxt = formatDate(c.inicio);
      const svcName = c.service === "internet" ? "Internet" : "Cable/TV";

      const contact = [
        c.dni ? `DNI: <b>${escapeHtml(c.dni)}</b>` : "",
        c.whatsapp ? `WA: <b>${escapeHtml(c.whatsapp)}</b>` : "<span class='muted'>Sin WhatsApp</span>"
      ].filter(Boolean).join("<br>");

      const payTxt = c.paid
        ? `‚úÖ <b>Cancelado</b>${c.paidAt ? ` ‚Ä¢ ${escapeHtml(formatDate(c.paidAt))}` : ""}`
        : `üü° <b>Pendiente</b> ‚Ä¢ Deuda: <b>S/ ${money(c.precio)}</b>`;

      return `
        <div class="item">
          <div class="itemTop">
            <div>
              <div class="name">${escapeHtml(c.nombre)}</div>
              <div class="meta">
                ${contact}<br>
                <span class="muted">Servicio:</span> <b>${svcName}</b><br>
                <span class="muted">Plan:</span> <b>${escapeHtml(c.plan || svcName)}</b> ‚Ä¢ <span class="muted">Precio:</span> <b>S/ ${money(c.precio)}</b><br>
                <span class="muted">Inicio:</span> <b>${inicioTxt}</b> ‚Ä¢ <span class="muted">Vence:</span> <b>${venceTxt}</b><br>
                ${daysText(st)}<br>
                <span class="muted">Pago:</span> ${payTxt}
              </div>
            </div>

            <div class="badges">
              ${serviceBadge(st)}
              ${paymentBadge(c)}
            </div>
          </div>

          <div class="itemBtns noPrint">
            <button class="btn small" data-act="edit" data-id="${c.id}" type="button">‚úèÔ∏è Editar</button>
            <button class="btn small ok" data-act="receipt" data-id="${c.id}" type="button">üßæ Recibo</button>

            ${c.paid
              ? `<button class="btn small warn" data-act="unpaid" data-id="${c.id}" type="button">‚Ü©Ô∏è Pendiente</button>`
              : `<button class="btn small ok" data-act="paid" data-id="${c.id}" type="button">‚úÖ Pag√≥</button>`
            }

            <button class="btn small ok" data-act="paidMsg" data-id="${c.id}" type="button">üì® Confirmaci√≥n</button>
            <button class="btn small danger" data-act="del" data-id="${c.id}" type="button">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderAll(){
    el.bizTitle.textContent = BUSINESS_NAME;
    el.todayLbl.textContent = formatDate(todayISO());
    renderKPIs();
    renderList();
  }

  // ===== Export/Import/Reset =====
  function exportPayload(){
    return { app: BUSINESS_NAME, version: 8, exportedAt: new Date().toISOString(), clients: state.clients };
  }
  function exportJSON(){
    const payload = exportPayload();
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `control_lucerito_backup_${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importJSON(file){
    try{
      const text = await file.text();
      const payload = JSON.parse(text);
      const incoming = payload?.clients;
      if (!Array.isArray(incoming)) throw new Error("Archivo inv√°lido: no existe clients[]");

      const cleaned = incoming
        .filter(x => x && typeof x === "object")
        .map(x => ({
          id: String(x.id || uid()),
          service: (x.service === "tv" ? "tv" : "internet"),
          nombre: String(x.nombre || ""),
          dni: String(x.dni || ""),
          whatsapp: normalizePhone(String(x.whatsapp || "")),
          plan: String(x.plan || ""),
          precio: Number(x.precio || 0),
          inicio: String(x.inicio || todayISO()),
          diasPagados: Number(x.diasPagados || 30),
          notas: String(x.notas || ""),
          paid: !!x.paid,
          paidAt: String(x.paidAt || ""),
          lastReceipt: (x.lastReceipt && typeof x.lastReceipt === "object")
            ? { no: Number(x.lastReceipt.no || 0), vence: String(x.lastReceipt.vence || ""), createdAt: Number(x.lastReceipt.createdAt || Date.now()) }
            : undefined,
          createdAt: Number(x.createdAt || Date.now()),
          updatedAt: Number(x.updatedAt || Date.now())
        }))
        .filter(x => x.nombre.trim().length > 0);

      state.clients = cleaned;
      await saveSmart("import");
      renderAll();
      alert("Importado ‚úÖ");
    }catch(err){
      alert("No se pudo importar ‚ùå\n" + (err?.message || err));
    }
  }

  async function resetAll(){
    if (!confirm("¬øSeguro? Esto borrar√° TODO.")) return;
    state.clients = [];
    await saveSmart("reset");
    renderAll();
    newClientForm();
    setTab("home");
  }

  // ===== Load =====
  function load(){
    // theme
    const th = localStorage.getItem(KEYS.theme);
    applyTheme(th === "light" ? "light" : "dark");

    // cloud
    const cl = localStorage.getItem(KEYS.cloud);
    applyCloud(cl === "on" ? "on" : "off");

    // local cache (siempre)
    loadLocal();

    // online/offline badge
    const updateOnline = () => setCloudState(navigator.onLine ? "üü¢ Online" : "üî¥ Offline", !!navigator.onLine);
    window.addEventListener("online", updateOnline);
    window.addEventListener("offline", updateOnline);
    updateOnline();
  }

  // ===== Events =====
  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

  el.btnSvcInternet.addEventListener("click", () => setService("internet"));
  el.btnSvcTv.addEventListener("click", () => setService("tv"));

  el.goClients.addEventListener("click", () => setTab("clients"));
  el.goAdd.addEventListener("click", () => { newClientForm(); setTab("add"); });

  el.btnNew.addEventListener("click", () => { newClientForm(); setTab("add"); });
  el.btnBackClients.addEventListener("click", () => setTab("clients"));

  el.inicio.addEventListener("change", updateVencePreview);
  el.diasPagados.addEventListener("input", updateVencePreview);

  el.pagoEstado.addEventListener("change", () => {
    if (el.pagoEstado.value === "paid" && !el.pagoFecha.value) el.pagoFecha.value = todayISO();
    if (el.pagoEstado.value === "pending") el.pagoFecha.value = "";
  });

  el.form.addEventListener("submit", async (e) => { e.preventDefault(); await upsertFromForm(); });
  el.btnClear.addEventListener("click", newClientForm);

  el.btnDelete.addEventListener("click", async () => state.selectedId && await removeClient(state.selectedId));
  el.btnReceiptFromForm.addEventListener("click", () => state.selectedId && openReceipt(state.selectedId));
  el.btnConfirmPaidFromForm.addEventListener("click", () => state.selectedId && waPaidConfirmation(state.selectedId));

  el.q.addEventListener("input", renderList);
  el.fAll.addEventListener("click", () => setFilter("all"));
  el.fActive.addEventListener("click", () => setFilter("active"));
  el.fSoon.addEventListener("click", () => setFilter("soon"));
  el.fExpired.addEventListener("click", () => setFilter("expired"));
  el.fPayPending.addEventListener("click", () => setFilter("payPending"));
  el.fPaid.addEventListener("click", () => setFilter("paid"));

  el.list.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    if (!id || !act) return;

    if (act === "edit"){
      const c = state.clients.find(x => x.id === id);
      if (c){ fillForm(c); setTab("add"); }
    }
    if (act === "receipt") openReceipt(id);
    if (act === "del") await removeClient(id);

    if (act === "paid"){ await markPaid(id, true); alert("Marcado como ‚úÖ Cancelado"); }
    if (act === "unpaid"){ await markPaid(id, false); alert("Marcado como üü° Pendiente"); }
    if (act === "paidMsg"){ waPaidConfirmation(id); }
  });

  el.btnClose.addEventListener("click", closeReceipt);
  el.back.addEventListener("click", (e) => { if (e.target === el.back) closeReceipt(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeReceipt(); });

  el.btnPrint.addEventListener("click", () => window.print());

  el.btnThemeToggle.addEventListener("click", toggleTheme);

  // Cloud buttons
  el.btnCloudToggle.addEventListener("click", async () => {
    const next = (state.cloud === "on") ? "off" : "on";
    applyCloud(next);

    if (next === "on"){
      setCloudState("üü° Conectando‚Ä¶", true);
      const ok = await cloudInitIfNeeded();
      if (!ok){
        applyCloud("off");
        setCloudState("üî¥ Error", false);
        return;
      }

      // Al activar: bajar nube ‚Üí luego suscripci√≥n en vivo
      await cloudDownloadToLocal();
      cloudLiveSubscribe();
      alert("Guardado en l√≠nea ACTIVADO ‚úÖ");
    } else {
      if (state.cloudUnsub) { state.cloudUnsub(); state.cloudUnsub = null; }
      alert("Guardado en l√≠nea DESACTIVADO.");
    }
  });

  el.btnCloudSyncNow.addEventListener("click", async () => {
    if (state.cloud !== "on") return alert("Activa el guardado en l√≠nea primero.");
    setCloudState("üü° Sincronizando‚Ä¶", true);
    try{
      await cloudUploadAll();
      setCloudState("üü¢ Sincronizado", true);
      alert("Sincronizado ‚úÖ");
    }catch(e){
      console.error(e);
      setCloudState("üî¥ Error", false);
      alert("No se pudo sincronizar. Revisa tu internet.");
    }
  });

  // Export/Import
  el.btnExport.addEventListener("click", exportJSON);
  el.btnImport.addEventListener("click", () => el.importFile.click());
  el.importFile.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (f) await importJSON(f);
    el.importFile.value = "";
  });

  el.btnReset.addEventListener("click", async () => await resetAll());

  // ===== Init =====
  (function init(){
    load();
    newClientForm();
    setService("internet");
    setFilter("all", false);
    renderAll();
    setTab("home");
    setCloudBadge(state.cloud === "on");

    // Si cloud estaba ON, reconectar
    if (state.cloud === "on"){
      cloudInitIfNeeded().then(async (ok) => {
        if (!ok) return;
        await cloudDownloadToLocal();
        cloudLiveSubscribe();
      });
    }
  })();
</script>
</body>
</html>